<!-- public/abonim.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏ - –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .autocomplete-list {
      position: absolute;
      width: 100%;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      z-index: 100;
      list-style: none;
      padding-left: 0;
    }
    .autocomplete-list li {
      padding: 8px;
      cursor: pointer;
    }
    .autocomplete-list li:hover {
      background-color: #f0f0f0;
    }
     
 .active-tag,
.inactive-tag {
  padding: 4px 8px;
  border-radius: 4px;
  color: white;
  font-weight: bold;
  display: inline-block;
  font-size: 12px;
}
.active-tag {
  background-color: #5cb85c; /* –ó–µ–ª—ë–Ω—ã–π –¥–ª—è "–ê–∫—Ç–∏–≤–Ω—ã–π" */
}
.inactive-tag {
  background-color: #e98380; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω" */
}
  /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
  .clients-table button {
    background: none;
    border: none;
    padding: 0;
    margin: 0 3px;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
  }
  
  .clients-table button:hover {
    opacity: 0.7;
    transform: scale(1.1);
    transition: all 0.2s ease;
  }
  .filter-form button:hover {
  background-color: #e1d4c1 !important; /* –ë–µ–∂–µ–≤—ã–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
}
.autocomplete-wrapper {
  flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
}

#filterClientInput {
  width: 100%; /* –†–∞—Å—Ç—è–Ω—É—Ç—å –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —Ä–æ–¥–∏—Ç–µ–ª—è */
}

  </style>
</head>
<body>

<!-- –®–∞–ø–∫–∞ -->
<div class="header">
  <img src="/pictures/logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height: 40px; margin-right: 15px;" />
  <h1>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏</h1>
  <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–∞–≤–∞ -->
  <div class="user-greeting" id="userGreeting">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- –ú–µ–Ω—é -->
<nav class="menu">
  <a href="/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
  <a href="/clients.html">–ö–ª–∏–µ–Ω—Ç—ã</a>
  <a href="/teachers.html">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</a>
  <a href="/abonim.html" class="active">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</a>
  <a href="/sections.html">–°–µ–∫—Ü–∏–∏</a>
  <a href="/records.html">–ó–∞–ø–∏—Å–∏</a>
  <a href="/login.html" class="logout-button">–í—ã–π—Ç–∏</a>
</nav>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div class="container">

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
  <div id="toastContainer"></div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ -->
  <div class="section-form">
    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç</h3>
    <input type="hidden" id="abonimId" />
    <div class="form-grid">
      <!-- –ö–ª–∏–µ–Ω—Ç -->
      <div class="input-group autocomplete-wrapper">
        <label for="clientInput">–ö–ª–∏–µ–Ω—Ç</label>
        <input type="text" id="clientInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞" autocomplete="off" oninput="handleClientInput(this.value)" onfocus="handleClientInput(this.value)" />
        <ul id="clientSuggestions" class="autocomplete-list"></ul>
        <input type="hidden" id="clientId" />
      </div>

      <!-- –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ -->
      <div class="input-group">
        <label for="startDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
        <input type="date" id="startDate" onchange="calculateEndDate()" />
      </div>

      <!-- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
      <div class="input-group">
        <label for="endDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
        <input type="date" id="endDate" disabled />
      </div>

      <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π -->
      <div class="input-group">
        <label for="visitCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π</label>
        <input type="number" id="visitCount" min="1" />
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
  <div style="margin-top: 10px; margin-bottom: 30px;">
  <button id="saveButton" onclick="addAbonim()" style="background-color: var(--secondary); color: black;">–î–æ–±–∞–≤–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç</button>
</div>
  </div>
<!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
<div class="filter-form" style="margin-bottom: 20px;">
  <h4>–§–∏–ª—å—Ç—Ä</h4>
  <div class="form-grid" style="grid-template-columns: repeat(3, 1fr) auto; gap: 10px;">
    <!-- –ö–ª–∏–µ–Ω—Ç -->
    <div class="autocomplete-wrapper">
      <input type="text" id="filterClientInput" placeholder="–ö–ª–∏–µ–Ω—Ç" autocomplete="off"
             oninput="handleFilterClientInput(this.value)" onfocus="handleFilterClientInput(this.value)" />
      <ul id="filterClientSuggestions" class="autocomplete-list"></ul>
      <input type="hidden" id="filterClientId" />
    </div>
    <!-- –î–∞—Ç–∞ –æ—Ç -->
    <input type="date" id="filterDateFrom" placeholder="–î–∞—Ç–∞ –æ—Ç" onchange="loadAbonims()" />
    <!-- –°—Ç–∞—Ç—É—Å -->
    <select id="filterStatus" onchange="loadAbonims()">
      <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="–∞–∫—Ç–∏–≤–µ–Ω">–ê–∫—Ç–∏–≤–µ–Ω</option>
      <option value="–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</option>
    </select>
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
    <button onclick="resetFilters()" style="background-color: #c1c6f1;">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
  </div>
</div>
  <!-- –¢–∞–±–ª–∏—Ü–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ -->
  <table class="clients-table" style="margin-top: 30px;">
    <thead>
      <tr>
      <th onclick="sortAbonims('id')">ID<span class="sort-indicator" id="sort-id">‚Üï</span></th>
<th onclick="sortAbonims('client_full_name')">–ö–ª–∏–µ–Ω—Ç<span class="sort-indicator" id="sort-client_full_name">‚Üï</span></th>
<th onclick="sortAbonims('startDate')">–ù–∞—á–∞–ª–æ<span class="sort-indicator" id="sort-startDate">‚Üï</span></th>
<th onclick="sortAbonims('endDate')">–û–∫–æ–Ω—á–∞–Ω–∏–µ<span class="sort-indicator" id="sort-endDate">‚Üï</span></th>
<th onclick="sortAbonims('visited_count')">–ü–æ—Å–µ—â–µ–Ω–æ<span class="sort-indicator" id="sort-visited_count">‚Üï</span></th>
<th onclick="sortAbonims('status')">–°—Ç–∞—Ç—É—Å<span class="sort-indicator" id="sort-status">‚Üï</span></th>
<th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="abonimList"></tbody>
  </table>

  <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  <div class="pagination" id="pagination"></div>

</div>

<script>
  // === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
  let currentPage = 1;
  const itemsPerPage = 10;
  let sortField = "startDate";
  let sortDirection = "asc";
  let allClients = [];

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  document.addEventListener("DOMContentLoaded", async () => {
    loadAbonims();
    initAutocomplete();
  });

  // === –†–∞—Å—á—ë—Ç –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ ===
  function calculateEndDate() {
    const start = new Date(document.getElementById("startDate").value);
    if (!start) return;
    const end = new Date(start);
    end.setMonth(end.getMonth() + 1);
    document.getElementById("endDate").value = end.toISOString().split("T")[0];
  }

  // === –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
  async function handleClientInput(query) {
    const suggestions = document.getElementById("clientSuggestions");
    suggestions.innerHTML = "";
    if (!query.trim()) {
      suggestions.classList.remove("show");
      return;
    }

    try {
      const res = await fetch(`/api/clients?search=${encodeURIComponent(query)}`);
      const data = await res.json();
      const clients = Array.isArray(data.data) ? data.data : [];
      if (clients.length === 0) {
        suggestions.innerHTML = `<li style="color:#999; text-align:center">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</li>`;
      } else {
   clients.forEach(client => {
  const li = document.createElement("li");
  const fullName = client.fullName || client.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'; // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
  li.textContent = fullName;
  li.dataset.id = client.id;
  li.onclick = () => {
    document.getElementById("clientInput").value = fullName;
    document.getElementById("clientId").value = client.id;
    suggestions.innerHTML = "";
  };
  suggestions.appendChild(li);
});
      }
      suggestions.classList.add("show");
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤:", err);
      suggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>`;
    }
  }

  // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ ===
  async function addAbonim() {
  const clientId = document.getElementById("clientId").value;
  const startDate = document.getElementById("startDate").value;
  const visitCount = document.getElementById("visitCount").value;

  if (!clientId || !startDate || !visitCount) {
    showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "error");
    return;
  }

  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã
    const checkRes = await fetch(`/api/abonim?clientId=${clientId}&status=active`);
    const checkData = await checkRes.json();
    
    if (checkData.data && checkData.data.length > 0) {
      showToast("–£ –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç", "error");
      return;
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç
    const res = await fetch("/api/abonim", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        clientId,
        startDate,
        visitCount
      })
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.message || "–û—à–∏–±–∫–∞");

    showToast("–ê–±–æ–Ω–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω");
    clearForm();
    loadAbonims();
  } catch (err) {
    showToast(err.message, "error");
  }
}

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ ===
  async function loadAbonims(page = 1) {
  try {
    const url = new URL("/api/abonim", window.location.origin);
    url.searchParams.append("page", page);
    url.searchParams.append("limit", itemsPerPage);
    url.searchParams.append("sort", sortField);
    url.searchParams.append("order", sortDirection);

    // –§–∏–ª—å—Ç—Ä—ã
    let status = document.getElementById("filterStatus").value;
    const dateFrom = document.getElementById("filterDateFrom").value;
    const clientId = document.getElementById("filterClientId").value;

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞
    if (status) {
      status = status.charAt(0).toUpperCase() + status.slice(1).toLowerCase();
      url.searchParams.append("status", status);
    }
    
    if (dateFrom) url.searchParams.append("startDate", dateFrom);
    if (clientId) url.searchParams.append("clientId", clientId);

    const res = await fetch(url);
    const data = await res.json();
    renderAbonims(data);
    updatePagination(data);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤:", err);
    showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", "error");
  }
}

  // === –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã ===
 function renderAbonims(data) {
  const tbody = document.getElementById("abonimList");
  tbody.innerHTML = "";

  if (!data.data || data.data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>`;
    return;
  }

  data.data.forEach(abonim => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${abonim.id}</td>
      <td>${abonim.clientFullName || abonim.client_full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
      <td>${new Date(abonim.start_date).toLocaleDateString()}</td>
      <td>${new Date(abonim.end_date).toLocaleDateString()}</td>
      <td>${abonim.visited_count}/${abonim.visit_count}</td>
<td><span class="${abonim.status.toLowerCase() === '–∞–∫—Ç–∏–≤–µ–Ω' ? 'active-tag' : 'inactive-tag'}">${abonim.status}</span></td>
      <td>
        <button onclick="editAbonim(${abonim.id})">‚úèÔ∏è</button>
        <button onclick="deleteAbonim(${abonim.id})">üóëÔ∏è</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}
  // === –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ===
  function sortAbonims(field) {
    if (sortField === field) {
      sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
      sortField = field;
      sortDirection = "asc";
    }
    updateSortIndicators();
    currentPage = 1;
    loadAbonims(currentPage);
  }

function updateSortIndicators() {
  const indicators = document.querySelectorAll(".sort-indicator");
  indicators.forEach(el => el.textContent = "‚Üï");
  const indicator = document.getElementById(`sort-${sortField}`);
  if (indicator) {
    indicator.textContent = sortDirection === "asc" ? "‚Üë" : "‚Üì";
  }
}

  // === –ü–∞–≥–∏–Ω–∞—Ü–∏—è ===
  function updatePagination(data) {
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";
  const currentPage = data.currentPage || 1;
  const totalPages = data.totalPages || 1;

  // ‚Üê –°—Ç—Ä–µ–ª–∫–∞ "–ù–∞–∑–∞–¥" (–≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è)
  const prevBtn = document.createElement("button");
  prevBtn.textContent = "‚Üê";
  if (currentPage <= 1) {
    prevBtn.disabled = true;
    prevBtn.style.opacity = "0.5";
  } else {
    prevBtn.onclick = () => {
      currentPage--;
      loadAbonims(currentPage);
    };
  }
  pagination.appendChild(prevBtn);

  // –ö–Ω–æ–ø–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === currentPage) {
      btn.disabled = true;
    }
    btn.onclick = () => {
      currentPage = i;
      loadAbonims(i);
    };
    pagination.appendChild(btn);
  }

  // ‚Üí –°—Ç—Ä–µ–ª–∫–∞ "–í–ø–µ—Ä–µ–¥" (–≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è)
  const nextBtn = document.createElement("button");
  nextBtn.textContent = "‚Üí";
  if (currentPage >= totalPages) {
    nextBtn.disabled = true;
    nextBtn.style.opacity = "0.5";
  } else {
    nextBtn.onclick = () => {
      currentPage++;
      loadAbonims(currentPage);
    };
  }
  pagination.appendChild(nextBtn);
}

  // === –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    document.getElementById("toastContainer").appendChild(toast);
    setTimeout(() => {
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }, 100);
  }

  // === –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã ===
  function clearForm() {
    document.getElementById("clientInput").value = "";
    document.getElementById("clientId").value = "";
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("visitCount").value = "";
    document.getElementById("abonimId").value = "";
    document.getElementById("formTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç";
    document.getElementById("saveButton").onclick = addAbonim;
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
  function initAutocomplete() {
    const input = document.getElementById("clientInput");
    input.addEventListener("focus", async () => {
      if (allClients.length === 0) await loadAllClients();
    });
  }

  async function loadAllClients() {
    try {
      const res = await fetch("/api/clients", { credentials: "include" });
      const data = await res.json();
      allClients = Array.isArray(data.data) ? data.data : [];
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:", e);
    }
  }

  // === –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ ===
  async function editAbonim(id) {
  try {
    const res = await fetch(`/api/abonim/${id}`, {
      method: "GET",
      credentials: 'include'
    });

    if (!res.ok) {
      throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${res.status}`);
    }

    const abonimData = await res.json();

    let abonim;
    if (abonimData.success && abonimData.data) {
      abonim = abonimData.data;
    } else {
      abonim = abonimData;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ client_full_name –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∞
    if (!abonim || (!abonim.client_full_name && !abonim.clientFullName)) {
      console.warn("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", abonim);
      throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞");
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    document.getElementById("clientInput").value = abonim.client_full_name || abonim.clientFullName;
    document.getElementById("clientId").value = abonim.client_id;
    document.getElementById("startDate").value = abonim.start_date?.split("T")[0];
    calculateEndDate();
    document.getElementById("visitCount").value = abonim.visit_count;
    document.getElementById("abonimId").value = abonim.id;

    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    document.getElementById("formTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç";
    const saveButton = document.getElementById("saveButton");
    saveButton.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    saveButton.onclick = function () {
      saveEditedAbonim(id); // –ü–µ—Ä–µ–¥–∞–µ–º id –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    };

  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:", err);
    showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, "error");
  }
}
  // === –£–¥–∞–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ ===
  async function deleteAbonim(id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç?")) return;
    try {
      const res = await fetch(`/api/abonim/${id}`, { method: "DELETE" });
      const result = await res.json();
      if (!res.ok) throw new Error(result.message || "–û—à–∏–±–∫–∞");
      showToast("–ê–±–æ–Ω–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω");
      loadAbonims();
    } catch (err) {
      showToast(err.message, "error");
    }
  }
  async function handleFilterClientInput(query) {
  const suggestions = document.getElementById("filterClientSuggestions");
  suggestions.innerHTML = "";
  if (!query.trim()) {
    suggestions.classList.remove("show");
    return;
  }
  try {
    const res = await fetch(`/api/clients?search=${encodeURIComponent(query)}`);
    const data = await res.json();
    const clients = Array.isArray(data.data) ? data.data : [];
    if (clients.length === 0) {
      suggestions.innerHTML = `<li style="color:#999; text-align:center">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</li>`;
    } else {
      clients.forEach(client => {
        const li = document.createElement("li");
        const fullName = client.fullName || client.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        li.textContent = fullName;
        li.dataset.id = client.id;
        li.onclick = () => {
          document.getElementById("filterClientInput").value = fullName;
          document.getElementById("filterClientId").value = client.id;
          suggestions.innerHTML = "";
          loadAbonims();
        };
        suggestions.appendChild(li);
      });
    }
    suggestions.classList.add("show");
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤:", err);
    suggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>`;
  }
}
function resetFilters() {
  // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  document.getElementById("filterStatus").value = "";
  document.getElementById("filterDateFrom").value = "";
  document.getElementById("filterClientInput").value = "";
  document.getElementById("filterClientId").value = "";

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ
  currentPage = 1;
  loadAbonims(currentPage);
}
async function saveEditedAbonim(id) {
  const clientId = document.getElementById("clientId").value;
  const startDate = document.getElementById("startDate").value;
  const visitCount = document.getElementById("visitCount").value;

  if (!clientId || !startDate || !visitCount) {
    showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "error");
    return;
  }

  const body = {
    clientId,
    startDate,
    visitCount
  };

  try {
    const res = await fetch(`/api/abonim/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: 'include',
      body: JSON.stringify(body)
    });

    const result = await res.json();

    if (!res.ok) {
      throw new Error(result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
    }

    showToast("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
    clearForm();
    loadAbonims(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫

  } catch (err) {
    showToast(err.message, "error");
  }
}
async function getUserInfo() {
    try {
      const response = await fetch('/api/auth/check', {
        method: 'GET',
        credentials: 'include'
      });

      if (!response.ok) {
        sessionStorage.removeItem("isAuthenticated");
        window.location.href = "/login.html";
        return null;
      }

      const data = await response.json();
      return data.user || null;

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      sessionStorage.removeItem("isAuthenticated");
      window.location.href = "/login.html";
      return null;
    }
  }

  // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
  function displayUserInfo(user) {
    const greetingElement = document.getElementById('userGreeting');
    if (!greetingElement) return;

    let roleText = '';

    if (user.role === 'admin') {
      roleText = user.type === 'subadmin' ? '–º–ª–∞–¥—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '—Å—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
    } else {
      roleText = user.role;
    }

    greetingElement.innerHTML = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${roleText}`;
  }

  // –°–∫—Ä—ã–≤–∞–µ—Ç –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é –¥–ª—è –º–ª–∞–¥—à–µ–≥–æ –∞–¥–º–∏–Ω–∞
function toggleMenuVisibility(user) {
  // –°–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ —Å–µ–∫—Ü–∏–π
  const teachersLink = document.querySelector('nav.menu a[href="/teachers.html"]');
  const sectionsLink = document.querySelector('nav.menu a[href="/sections.html"]');

  if (user && user.role === 'admin' && user.type === 'subadmin') {
    if (teachersLink) teachersLink.style.display = 'none';
    if (sectionsLink) sectionsLink.style.display = 'none';
  }
}

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω–µ –¥–ª—è subadmin
  window.showToast = function(message, type = "success") {
    const toastContainer = document.getElementById("toastContainer");
    if (!toastContainer) return;

    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    toastContainer.appendChild(toast);

    setTimeout(() => {
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }, 100);
  };

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener("DOMContentLoaded", async () => {
    const user = await getUserInfo();
    if (!user) return;

    displayUserInfo(user);
    toggleMenuVisibility(user);
  });

</script>

</body>
</html>