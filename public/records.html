<!-- public/records.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏ - –ó–∞–ø–∏—Å–∏</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .autocomplete-list {
      display: none;
      position: absolute;
      border: 1px solid #ccc;
      background: white;
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }
    .autocomplete-list.show {
      display: block;
    }
    .autocomplete-list li {
      padding: 6px 10px;
      cursor: pointer;
    }
    .autocomplete-list li:hover {
      background-color: #f0f0f0;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: green;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      animation: fadeToast 0.3s ease forwards;
    }
    .toast.error {
      background: red;
    }
    @keyframes fadeToast {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 30%;
      width: 40%;
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      border-radius: 8px;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    .filter-form {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .form-inline {
      display: flex;
      gap: 15px;
      align-items: end;
      flex-wrap: wrap;
    }
    .input-group {
      flex: 1 1 200px;
      min-width: 200px;
    }
    .input-group label {
      font-size: 0.9em;
      color: #000;
    }
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .filter-form button {
      padding: 8px 16px;
      white-space: nowrap;
      background-color: #c1c6f1;
      color: black;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .filter-form button:hover {
      background-color: #fff1e5;
    }

    .lessons-table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .lessons-table thead {
      background-color: #f5f5f5;
    }
    .lessons-table th,
    .lessons-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .lessons-table th {
      cursor: pointer;
      color: #000000;
      font-weight: normal;
    }
    .sort-indicator {
      margin-left: 5px;
      font-size: 0.9em;
      color: #000000;
    }

    .record-form {
      margin-bottom: 20px;
    }

    .record-form button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
    }

  </style>
</head>
<body>
<div class="header">
  <img src="/pictures/logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height: 40px; margin-right: 15px;">
  <h1>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏</h1>
  <div class="user-greeting" id="userGreeting">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
  <nav class="menu">
    <a href="/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
    <a href="/clients.html">–ö–ª–∏–µ–Ω—Ç—ã</a>
    <a href="/teachers.html">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</a>
    <a href="/abonim.html">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</a>
    <a href="/sections.html">–°–µ–∫—Ü–∏–∏</a>
    <a href="/records.html" class="active">–ó–∞–ø–∏—Å–∏</a>
    <a href="/login.html" class="logout-button">–í—ã–π—Ç–∏</a>
  </nav>

  <div class="container">
    <div id="toastContainer"></div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
    <div class="record-form">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
      <div class="form-grid">
        <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
        <div class="input-group autocomplete-wrapper">
          <label for="scheduleInput">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</label>
          <input type="text" id="scheduleInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è"
                 oninput="handleScheduleInput(this.value)" onfocus="handleScheduleInput(this.value)">
          <ul id="scheduleSuggestions" class="autocomplete-list"></ul>
          <input type="hidden" id="scheduleId">
        </div>
        <!-- –ö–ª–∏–µ–Ω—Ç -->
        <div class="input-group autocomplete-wrapper">
          <label for="clientInput">–ö–ª–∏–µ–Ω—Ç</label>
          <input type="text" id="clientInput" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞"
                 oninput="handleClientInput(this.value)" onfocus="handleClientInput(this.value)">
          <input type="hidden" id="clientId">
          <ul id="clientSuggestions" class="autocomplete-list"></ul>
        </div>
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å" –æ—Ç–¥–µ–ª—å–Ω–æ -->
    <div style="margin-bottom: 20px;">
      <button onclick="addRecord()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>

<!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<div class="filter-form inline-filter-form">
  <h3>–§–∏–ª—å—Ç—Ä</h3>
  <div class="form-inline">
    <!-- –î–∞—Ç–∞ -->
    <div class="input-group">
      <label for="filterDate">–î–∞—Ç–∞</label>
      <input type="date" id="filterDate" onchange="debouncedFilter()">
    </div>
    <!-- –°–µ–∫—Ü–∏—è -->
    <div class="input-group autocomplete-wrapper">
      <label for="filterSectionInput">–°–µ–∫—Ü–∏—è</label>
      <input type="text" id="filterSectionInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–∏"
             oninput="handleSectionFilterInput(this.value)" onfocus="handleSectionFilterInput(this.value)">
      <ul id="filterSectionSuggestions" class="autocomplete-list"></ul>
    </div>
    <!-- –ö–ª–∏–µ–Ω—Ç -->
    <div class="input-group autocomplete-wrapper">
      <label for="filterClientInput">–ö–ª–∏–µ–Ω—Ç</label>
      <input type="text" id="filterClientInput" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞"
             oninput="handleClientFilterInput(this.value)" onfocus="handleClientFilterInput(this.value)">
      <ul id="filterClientSuggestions" class="autocomplete-list"></ul>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
    <button type="button" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
  </div>
</div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–∏—Å–µ–π -->
    <table class="lessons-table">
      <thead>
        <tr>
          <th onclick="sortBy('id')">ID <span class="sort-indicator" id="sort-id">‚Üï</span></th>
          <th onclick="sortBy('date')">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è <span class="sort-indicator" id="sort-date">‚Üï</span></th>
          <th onclick="sortBy('teacherName')">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å <span class="sort-indicator" id="sort-teacherName">‚Üï</span></th>
          <th onclick="sortBy('sectionName')">–°–µ–∫—Ü–∏—è <span class="sort-indicator" id="sort-sectionName">‚Üï</span></th>
          <th onclick="sortBy('clientName')">–ö–ª–∏–µ–Ω—Ç <span class="sort-indicator" id="sort-clientName">‚Üï</span></th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="recordsList"></tbody>
    </table>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
  <div class="overlay" id="viewClientsOverlay"></div>
  <div class="modal" id="viewClientsModal">
    <h3>–ö–ª–∏–µ–Ω—Ç—ã –Ω–∞ –∑–∞–Ω—è—Ç–∏–∏</h3>
    <ul id="clientList"></ul>
    <button onclick="closeViewClients()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <script>
    let scheduleDebounce, clientDebounce, filterClientDebounce, filterSectionDebounce, filterDebounce;

    // === –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ===
    let sortField = 'id';
    let sortDirection = 'asc';

    // === –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ ===
function formatDateTime(dateStr, timeStr) {
  if (!dateStr || !timeStr) return '–ù/–î';

  // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
  const [year, month, day] = dateStr.split('T')[0].split('-');
  const [hours, minutes] = timeStr.split('T')[1]?.split(':') || timeStr.split(':');

  // –°–æ–±–∏—Ä–∞–µ–º –≤ –ø–æ–Ω—è—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
  return `${day}.${month}.${year} ${hours}:${minutes}`;
}


    // === –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ===
    async function handleClientInput(query) {
  clearTimeout(clientDebounce);
  const input = document.getElementById("clientInput");
  const suggestions = document.getElementById("clientSuggestions");

  if (!query.trim()) {
    suggestions.classList.remove("show");
    return;
  }

  clientDebounce = setTimeout(async () => {
    try {
      const res = await fetch(`/api/clients?search=${encodeURIComponent(query)}`, {
        method: 'GET',
        credentials: 'include'
      });

      if (!res.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${res.status}`);
      }

      const data = await res.json();
      const clients = Array.isArray(data) ? data : (data.data || []);

      suggestions.innerHTML = "";
      if (!clients.length) {
        suggestions.insertAdjacentHTML("beforeend", `<li>–ù–µ –Ω–∞–π–¥–µ–Ω–æ</li>`);
        suggestions.classList.add("show");
        return;
      }

      clients.forEach(client => {
        const fullName = client.full_name || client.fullName || client.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        const li = document.createElement("li");
        li.textContent = fullName;
        li.onclick = () => {
          input.value = fullName;
          document.getElementById("clientId").value = client.id;
          suggestions.classList.remove("show");
        };
        suggestions.appendChild(li);
      });

      suggestions.classList.add("show");
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤:", err);
      suggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>`;
      suggestions.classList.add("show");
    }
  }, 300);
}
  // === –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –≤–Ω–µ –∫–ª–∏–∫–∞ ===
  setupOutsideClickClose(".autocomplete-wrapper", "#scheduleSuggestions");
  setupOutsideClickClose(".autocomplete-wrapper", "#clientSuggestions");
  setupOutsideClickClose(".autocomplete-wrapper", "#filterClientSuggestions");
  setupOutsideClickClose(".autocomplete-wrapper", "#filterSectionSuggestions");
    // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ===
    async function addRecord() {
      const scheduleId = document.getElementById("scheduleId").value;
      const clientId = document.getElementById("clientId").value;
      if (!scheduleId || !clientId) {
        showToast("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ –∏ –∫–ª–∏–µ–Ω—Ç–∞", "error");
        return;
      }
      try {
        const response = await fetch("/api/records", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ scheduleId, clientId })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏");
        showToast("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞", "success");
        clearForm();
        loadRecords();
      } catch (error) {
        showToast(error.message, "error");
      }
    }

    // === –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã ===
    function clearForm() {
      document.getElementById("scheduleInput").value = "";
      document.getElementById("scheduleId").value = "";
      document.getElementById("clientInput").value = "";
      document.getElementById("clientId").value = "";
    }

    // === –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ===
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.innerText = message;
      document.getElementById("toastContainer").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π ===
    async function loadRecords(page = 1, filters = {}) {
  try {
    // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
    const url = new URL('/api/records', window.location.origin);

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    url.searchParams.set('page', page);

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    url.searchParams.set('sortField', sortField);
    url.searchParams.set('sortDirection', sortDirection);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –æ–±—ä–µ–∫—Ç–∞ filters
    Object.entries(filters).forEach(([key, value]) => {
      if (value) url.searchParams.set(key, value);
    });

    // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
    const res = await fetch(url);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
    if (!res.ok) {
      throw new Error("HTTP –æ—à–∏–±–∫–∞: " + res.status);
    }

    // –ü–∞—Ä—Å–∏–º JSON
    const data = await res.json();

    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª success: false ‚Äî –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    if (!data.success) {
      throw new Error(data.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π");
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É
    renderRecords(data);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    updatePagination(data);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    updateSortIndicators();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–ø–∏—Å–µ–π:", err);
    showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", "error");
  }
}

    // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π ===
    function renderRecords(data) {
      const tbody = document.getElementById("recordsList");
      tbody.innerHTML = "";
      if (!data.data || !data.data.length) {
        tbody.innerHTML = `<tr><td colspan="6">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
        return;
      }
      data.data.forEach(record => {
        const row = `
          <tr>
            <td>${record.id}</td>
            <td>${formatDateTime(record.date, record.startTime)}</td>
            <td>${record.teacherName}</td>
            <td>${record.sectionName}</td>
            <td>${record.clientName}</td>
            <td>
              <button onclick="viewClients(${record.scheduleId})">üëÅÔ∏è</button>
              <button onclick="deleteRecord(${record.id})">üóëÔ∏è</button>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    // === –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ===
    async function deleteRecord(id) {
      if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã?")) return;
      try {
        const res = await fetch(`/api/records/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
        showToast("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞");
        loadRecords();
      } catch (err) {
        showToast(err.message, "error");
      }
    }

    // === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
    async function viewClients(scheduleId) {
      const modal = document.getElementById("viewClientsModal");
      const overlay = document.getElementById("viewClientsOverlay");
      const list = document.getElementById("clientList");
      modal.style.display = "block";
      overlay.style.display = "block";
      list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
      try {
        const res = await fetch(`/api/schedule/${scheduleId}/clients`);
        const data = await res.json();
        list.innerHTML = "";
        if (!data.data || !data.data.length) {
          list.innerHTML = "<li>–ù–∞ —ç—Ç–æ –∑–∞–Ω—è—Ç–∏–µ –µ—â—ë –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è.</li>";
          return;
        }
        data.data.forEach(client => {
          const li = document.createElement("li");
          li.textContent = client.full_name;
          list.appendChild(li);
        });
      } catch (err) {
        list.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>`;
      }
    }

    function closeViewClients() {
      document.getElementById("viewClientsModal").style.display = "none";
      document.getElementById("viewClientsOverlay").style.display = "none";
      document.getElementById("clientList").innerHTML = "";
    }

    // === –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ===
    function sortBy(field) {
      if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortField = field;
        sortDirection = 'asc';
      }
      loadRecords(1);
    }

    function updateSortIndicators() {
      document.querySelectorAll(".sort-indicator").forEach(el => el.textContent = "‚Üï");
      const indicator = document.querySelector(`#sort-${sortField}`);
      if (indicator) {
        indicator.textContent = sortDirection === 'asc' ? "‚Üë" : "‚Üì";
      }
    }

    // === –ü–∞–≥–∏–Ω–∞—Ü–∏—è ===
function updatePagination(data) {
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
  const currentPage = data.currentPage || 1;
  const totalPages = data.totalPages || 1;
  
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
  const activeFilters = {
    clientName: document.getElementById('filterClientInput')?.value.trim() || '',
    sectionName: document.getElementById('filterSectionInput')?.value.trim() || '',
    scheduleDate: document.getElementById('filterDate')?.value.trim() || '' // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–ª—é—á
  };

  // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
  const prevBtn = document.createElement("button");
  prevBtn.innerHTML = "&laquo;";
  prevBtn.disabled = currentPage <= 1;
  prevBtn.addEventListener("click", () => {
    loadRecords(currentPage - 1, activeFilters);
  });
  pagination.appendChild(prevBtn);

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);
  
  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement("button");
    pageBtn.textContent = i;
    
    if (i === currentPage) {
      pageBtn.classList.add("active");
      pageBtn.disabled = true;
    }
    
    pageBtn.addEventListener("click", () => {
      loadRecords(i, activeFilters);
    });
    
    pagination.appendChild(pageBtn);
  }

  // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–ø–µ—Ä–µ–¥"
  const nextBtn = document.createElement("button");
  nextBtn.innerHTML = "&raquo;";
  nextBtn.disabled = currentPage >= totalPages;
  nextBtn.addEventListener("click", () => {
    loadRecords(currentPage + 1, activeFilters);
  });
  pagination.appendChild(nextBtn);

  // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
  const style = document.createElement("style");
  
  pagination.appendChild(style);
}
    // === –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
    async function handleClientFilterInput(query) {
      clearTimeout(filterClientDebounce);
      const suggestions = document.getElementById("filterClientSuggestions");
      filterClientDebounce = setTimeout(async () => {
        if (!query.trim()) {
          suggestions.innerHTML = "";
          return;
        }
        try {
          const res = await fetch(`/api/clients?search=${encodeURIComponent(query)}&limit=50`);
          const data = await res.json();
          const clients = Array.isArray(data) ? data : (data.data || []);
          suggestions.innerHTML = "";
          if (!clients.length) {
            suggestions.insertAdjacentHTML("beforeend", `<li>–ù–µ –Ω–∞–π–¥–µ–Ω–æ</li>`);
            return;
          }
          clients.forEach(client => {
            const fullName = client.fullName || client.full_name || client.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            const li = document.createElement("li");
            li.textContent = fullName;
            li.onclick = () => {
              document.getElementById("filterClientInput").value = fullName;
              suggestions.innerHTML = "";
              debouncedFilter();
            };
            suggestions.appendChild(li);
          });
          suggestions.classList.add("show");
        } catch (err) {
          suggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞</li>`;
        }
      }, 300);
    }

    // === –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —Å–µ–∫—Ü–∏–π ===
    async function handleSectionFilterInput(query) {
      clearTimeout(filterSectionDebounce);
      const suggestions = document.getElementById("filterSectionSuggestions");
      filterSectionDebounce = setTimeout(async () => {
        if (!query.trim()) {
          suggestions.innerHTML = "";
          return;
        }
        try {
          const res = await fetch(`/api/sections?search=${encodeURIComponent(query)}&limit=50`);
          const data = await res.json();
          const sections = Array.isArray(data) ? data : (data.data || []);
          suggestions.innerHTML = "";
          if (!sections.length) {
            suggestions.insertAdjacentHTML("beforeend", `<li>–ù–µ –Ω–∞–π–¥–µ–Ω–æ</li>`);
            return;
          }
          sections.forEach(section => {
            const name = section.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const li = document.createElement("li");
            li.textContent = name;
            li.onclick = () => {
              document.getElementById("filterSectionInput").value = name;
              suggestions.innerHTML = "";
              debouncedFilter();
            };
            suggestions.appendChild(li);
          });
          suggestions.classList.add("show");
        } catch (err) {
          suggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞</li>`;
        }
      }, 300);
    }


    // === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å debounce ===
function debouncedFilter() {
  clearTimeout(filterDebounce);
  filterDebounce = setTimeout(() => {
    const filters = {
      client: document.getElementById('filterClientInput').value.trim(),
      section: document.getElementById('filterSectionInput').value.trim(),
      date: document.getElementById('filterDate').value.trim() 
    };
    loadRecords(1, filters); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –Ω–æ–≤—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
  }, 300);
}

    // === –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ ===
    function resetFilters() {
      location.reload();
    }

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    window.onload = () => {
      loadRecords();
    };
   function setupOutsideClickClose(wrapperSelector, suggestionsSelector) {
  document.addEventListener("click", function handleClickOutside(e) {
    const wrapper = document.querySelector(wrapperSelector);
    const suggestions = document.querySelector(suggestionsSelector);
    if (!wrapper || !suggestions) return;
    if (!wrapper.contains(e.target)) {
      suggestions.classList.remove("show");
    }
  });
}


async function handleScheduleInput(query) {
  clearTimeout(scheduleDebounce);
  const input = document.getElementById("scheduleInput");
  const suggestions = document.getElementById("scheduleSuggestions");

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–∞–∂–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ
  suggestions.classList.toggle("show", !!query.trim());

  scheduleDebounce = setTimeout(async () => {
    try {
      const url = new URL('/api/schedule', window.location.origin);
      url.searchParams.set('search', query.trim());
      url.searchParams.set('searchFields', 'teacherName,sectionName');
      url.searchParams.set('limit', 50);

      const res = await fetch(url, { credentials: 'include' });
      
      if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ ${res.status}`);
      const data = await res.json();
      
      const lessons = Array.isArray(data) ? data : data?.data || [];
      renderScheduleSuggestions(lessons);

    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", err);
      suggestions.innerHTML = `
        <li class="error-msg">
          ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}
        </li>
      `;
    }
  }, 300);
}
function renderScheduleSuggestions(lessons) {
  const suggestions = document.getElementById("scheduleSuggestions");
  const input = document.getElementById("scheduleInput");
  
  suggestions.innerHTML = "";

  if (lessons.length === 0) {
    suggestions.innerHTML = `
      <li class="no-results">
        üïµÔ∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–Ω—è—Ç–∏–π –ø–æ –∑–∞–ø—Ä–æ—Å—É "${input.value}"
      </li>
    `;
    return;
  }

  lessons.forEach(lesson => {
    const li = document.createElement("li");
    li.className = "schedule-suggestion";
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    const dateObj = new Date(lesson.date);
    const date = dateObj.toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    
    const time = lesson.startTime?.slice(0, 5) || '--:--';

    li.innerHTML = `
      <div class="suggestion-main">
        <span class="teacher-name">${lesson.teacherName || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
        <span class="section-name">${lesson.sectionName || '–ë–µ–∑ —Å–µ–∫—Ü–∏–∏'}</span>
      </div>
      <div class="suggestion-details">
        <span class="datetime">üìÖ ${date}</span>
        <span class="datetime">‚è∞ ${time}</span>
      </div>
    `;

    li.onclick = () => {
      input.value = `${lesson.teacherName} - ${lesson.sectionName}`;
      document.getElementById("scheduleId").value = lesson.id;
      suggestions.classList.remove("show");
    };

    suggestions.appendChild(li);
  });
}
// –í—ã–∑–æ–≤—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
setupOutsideClickClose(".autocomplete-wrapper", "#scheduleSuggestions");
setupOutsideClickClose(".autocomplete-wrapper", "#clientSuggestions");
async function getUserInfo() {
  try {
    const response = await fetch('/api/auth/check', {
      method: 'GET',
      credentials: 'include'
    });
    if (!response.ok) {
      sessionStorage.removeItem("isAuthenticated");
      window.location.href = "/login.html";
      return null;
    }
    const data = await response.json();
    return data.user || null;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    sessionStorage.removeItem("isAuthenticated");
    window.location.href = "/login.html";
    return null;
  }
}
function displayUserInfo(user) {
  const greetingElement = document.getElementById('userGreeting');
  if (!greetingElement) return;
  let roleText = '';
  if (user.role === 'admin') {
    roleText = user.type === 'subadmin' ? '–º–ª–∞–¥—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '—Å—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
  } else {
    roleText = user.role;
  }
  greetingElement.innerHTML = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${roleText}`;
}
function toggleMenuVisibility(user) {
  const teachersLink = document.querySelector('nav.menu a[href="/teachers.html"]');
  const sectionsLink = document.querySelector('nav.menu a[href="/sections.html"]');
  if (user.role === 'admin' && user.type === 'subadmin') {
    if (teachersLink) teachersLink.style.display = 'none';
    if (sectionsLink) sectionsLink.style.display = 'none';
  }
}
document.addEventListener("DOMContentLoaded", async () => {
  const user = await getUserInfo();
  if (!user) return;
  displayUserInfo(user);
  toggleMenuVisibility(user);
});
function highlight(text, query) {
  if (!query) return text;
  const regex = new RegExp(query, 'gi');
  return text.replace(regex, match => `<b>${match}</b>`);
}
function getActiveFilters() {
  return {
    client: document.getElementById('filterClientInput').value.trim(),
    section: document.getElementById('filterSectionInput').value.trim(),
    date: document.getElementById('filterDate').value.trim()
  };
}
  </script>
</body>
</html