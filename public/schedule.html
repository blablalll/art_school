<!-- public/schedule.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏ - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è */
    .autocomplete-wrapper {
      position: relative;
    }
    .autocomplete-list {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      z-index: 1000;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
    }
    .autocomplete-list.show {
      display: block;
    }
    .autocomplete-list li {
      padding: 8px 12px;
      cursor: pointer;
    }
    .autocomplete-list li:hover {
      background-color: #f0f0f0;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 30%;
      width: 40%;
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      border-radius: 8px;
    }
    .modal h3 {
      margin-top: 0;
    }
    #clientList {
      list-style-type: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    #clientList li {
      padding: 8px 0;
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      transition: opacity 0.5s;
      display: none;
    }
    .toast.show {
      display: block;
      animation: fadeInOut 4s forwards;
    }
    .toast.error {
      background: red;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(20px); }
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —Å—Ç—Ä–æ–∫–∏ */
    tr.editing {
      background-color: #e6e6fa !important;
    }
  </style>
</head>
<body>

<!-- –®–∞–ø–∫–∞ -->
<div class="header">
  <img src="/pictures/logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height: 40px; margin-right: 15px;">
  <h1>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏</h1>
  <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–∞–≤–∞ -->
  <div class="user-greeting" id="userGreeting">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- –ú–µ–Ω—é -->
<nav class="menu">
  <a href="/schedule.html" class="active">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
  <a href="/clients.html">–ö–ª–∏–µ–Ω—Ç—ã</a>
  <a href="/teachers.html" id="teachersLink">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</a>
  <a href="/abonim.html">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</a>
  <a href="/sections.html" id="sectionsLink">–°–µ–∫—Ü–∏–∏</a>
  <a href="/records.html">–ó–∞–ø–∏—Å–∏</a>
  <a href="/login.html" class="logout-button">–í—ã–π—Ç–∏</a>
</nav>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div class="container">
  <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
  <div id="toastContainer"></div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
  <div class="schedule-form">
    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>
    <input type="hidden" id="scheduleId" />

    <div class="form-grid">
      <!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è -->
      <div class="input-group">
        <label for="dateTime">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
        <input type="datetime-local" id="dateTime" required />
      </div>

      <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å -->
      <div class="input-group autocomplete-wrapper">
        <label for="teacherInput">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label>
        <input type="text" id="teacherInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è" autocomplete="off" />
        <ul id="teacherSuggestions" class="autocomplete-list"></ul>
        <input type="hidden" id="teacherId" />
      </div>

      <!-- –°–µ–∫—Ü–∏—è -->
      <div class="input-group autocomplete-wrapper">
        <label for="sectionInput">–°–µ–∫—Ü–∏—è</label>
        <input type="text" id="sectionInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ü–∏—é" autocomplete="off" disabled />
        <ul id="sectionSuggestions" class="autocomplete-list"></ul>
        <input type="hidden" id="sectionId" />
      </div>

      <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
      <div class="input-group">
        <label for="duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
        <select id="duration">
          <option value="1">1 —á–∞—Å</option>
          <option value="1.5">1.5 —á–∞—Å–∞</option>
          <option value="2">2 —á–∞—Å–∞</option>
        </select>
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
    <div style="margin-top: 10px;">
      <button id="saveButton" onclick="addSchedule()" style="background-color: var(--secondary); color: black;">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
  <div class="filter-section small-filter">
    <div class="filter-header"><h3>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3></div>
    <div class="filter-row">
      <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
      <div class="input-group">
        <label for="filterDate">–î–∞—Ç–∞</label>
        <input type="date" id="filterDate" onchange="filterSchedule()" />
      </div>

      <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é -->
      <div class="input-group autocomplete-wrapper">
        <label for="filterTeacherInput">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label>
        <input type="text" id="filterTeacherInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è" autocomplete="off" oninput="handleFilterInput()" />
        <ul id="filterTeacherSuggestions" class="autocomplete-list"></ul>
        <input type="hidden" id="filterTeacherId" />
      </div>

      <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å–µ–∫—Ü–∏–∏ -->
      <div class="input-group autocomplete-wrapper">
        <label for="filterSectionInput">–°–µ–∫—Ü–∏—è</label>
        <input type="text" id="filterSectionInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ü–∏—é" autocomplete="off" oninput="handleFilterInput()" />
        <ul id="filterSectionSuggestions" class="autocomplete-list"></ul>
        <input type="hidden" id="filterSectionId" />
      </div>

      <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
      <div class="input-group">
        <label for="filterStatus">–°—Ç–∞—Ç—É—Å</label>
        <select id="filterStatus" onchange="filterSchedule()">
          <option value="">–í—Å–µ</option>
          <option value="free">–°–≤–æ–±–æ–¥–Ω–æ</option>
          <option value="busy">–ó–∞–Ω—è—Ç–æ</option>
        </select>
      </div>

      <!-- –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div class="input-group">
        <button onclick="clearFilters()" class="reset-button">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
  <table class="schedule-table">
    <thead>
      <tr>
        <th onclick="sortSchedule('id')">ID <span class="sort-indicator" id="sort-id">‚Üï</span></th>
        <th onclick="sortSchedule('date')">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è <span class="sort-indicator" id="sort-dateTime">‚Üï</span></th>
        <th onclick="sortSchedule('teacher')">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å <span class="sort-indicator" id="sort-teacher">‚Üï</span></th>
        <th onclick="sortSchedule('section')">–°–µ–∫—Ü–∏—è <span class="sort-indicator" id="sort-section">‚Üï</span></th>
        <th onclick="sortSchedule('duration')">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <span class="sort-indicator" id="sort-duration">‚Üï</span></th>
        <th onclick="sortSchedule('status')">–°—Ç–∞—Ç—É—Å <span class="sort-indicator" id="sort-status">‚Üï</span></th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="scheduleList"></tbody>
  </table>

  <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  <div class="pagination" id="pagination"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
<div class="overlay" id="viewClientsOverlay"></div>
<div class="modal" id="viewClientsModal">
  <h3>–ö–ª–∏–µ–Ω—Ç—ã –Ω–∞ –∑–∞–Ω—è—Ç–∏–∏</h3>
  <ul id="clientList"></ul>
  <button onclick="closeViewClients()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
<script>
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function checkAuth() {
  if (!sessionStorage.getItem("isAuthenticated")) {
    window.location.href = "/login.html";
  }
}

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getUserInfo() {
  try {
    const response = await fetch('/api/auth/check', {
      method: 'GET',
      credentials: 'include'
    });

    if (!response.ok) {
      sessionStorage.removeItem("isAuthenticated");
      window.location.href = "/login.html";
      return;
    }

    const data = await response.json();
    const user = data.user || {};

    displayUserInfo(user);
    toggleMenuVisibility(user);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    sessionStorage.removeItem("isAuthenticated");
    window.location.href = "/login.html";
  }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function displayUserInfo(user) {
  const greetingElement = document.getElementById('userGreeting');
  if (!greetingElement) return;

  let roleText = '';

  if (user.role === 'admin') {
    roleText = user.type === 'subadmin' ? '–º–ª–∞–¥—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '—Å—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
  } else {
    roleText = user.role;
  }

  greetingElement.innerHTML = `
    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${roleText}
  `;
}

// –°–∫—Ä—ã–≤–∞–µ–º –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é –¥–ª—è subadmin
function toggleMenuVisibility(user) {
  // –°–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ —Å–µ–∫—Ü–∏–π
  const teachersLink = document.querySelector('nav.menu a[href="/teachers.html"]');
  const sectionsLink = document.querySelector('nav.menu a[href="/sections.html"]');

  if (user && user.role === 'admin' && user.type === 'subadmin') {
    if (teachersLink) teachersLink.style.display = 'none';
    if (sectionsLink) sectionsLink.style.display = 'none';
  }
}

// –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener("DOMContentLoaded", () => {
  checkAuth();
  updateSortIndicators();
  loadAllTeachers();         // ‚Üê
  loadAllFilterSections();   // ‚Üê
  initAutocomplete();
  loadSchedule();
  getUserInfo(); // <-- –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
});

document.addEventListener("DOMContentLoaded", async () => {
  checkAuth();
  updateSortIndicators();
  await loadAllTeachers();         // ‚Üê
  await loadAllFilterSections();   // ‚Üê
  initAutocomplete();
  loadSchedule();
});
  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  let currentPage = 1;
  const itemsPerPage = 10;
  let sortField = "id";
  let sortDirection = "asc";
  let allTeachers = [];
  let allSections = [];
  let allFilterSections = [];

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  async function loadAllTeachers() {
    try {
      const res = await fetch("/api/teachers", { credentials: "include" });
      const data = await res.json();
      allTeachers = Array.isArray(data) ? data : Array.isArray(data.data) ? data.data : [];
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π:", e);
    }
  }

  async function loadAllFilterSections() {
    try {
      const res = await fetch("/api/sections", { credentials: "include" });
      const data = await res.json();
      allFilterSections = Array.isArray(data) ? data : Array.isArray(data.data) ? data.data : [];
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π:", e);
    }
  }

  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
  async function initAutocomplete() {
    const teacherInput = document.getElementById("teacherInput");
    const teacherSuggestions = document.getElementById("teacherSuggestions");
    const sectionInput = document.getElementById("sectionInput");
    const sectionSuggestions = document.getElementById("sectionSuggestions");

    let currentPage = 1;
    const limit = 10;
    let isLoading = false;
    let localTeachers = [];

    async function loadTeachers(page = 1, search = "") {
      if (isLoading) return;
      isLoading = true;
      try {
        const res = await fetch(`/api/teachers?page=${page}&limit=${limit}&search=${encodeURIComponent(search)}`, {
          credentials: "include"
        });
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π");
        const data = await res.json();
        let teachers = [];
        if (Array.isArray(data)) {
          teachers = data;
        } else if (Array.isArray(data.data)) {
          teachers = data.data;
        } else {
          throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
        }
        if (page === 1) {
          localTeachers = [...teachers];
          teacherSuggestions.innerHTML = "";
        } else {
          localTeachers = [...localTeachers, ...teachers];
        }
        showTeacherSuggestions(teacherInput, teacherSuggestions, localTeachers);
      } catch (error) {
        showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π: " + error.message, "error");
      } finally {
        isLoading = false;
      }
    }

    teacherInput.addEventListener("input", async (e) => {
      currentPage = 1;
      await loadTeachers(currentPage, e.target.value);
    });

    teacherInput.addEventListener("change", async () => {
      const teacher = localTeachers.find(t => t.fullName === teacherInput.value);
      if (teacher) {
        document.getElementById("teacherId").value = teacher.id;
        try {
          const res = await fetch(`/api/teachers/${teacher.id}/sections`, { credentials: "include" });
          const data = await res.json();
          if (res.ok && Array.isArray(data.data)) {
            allSections = data.data;
            sectionInput.disabled = false;
            sectionInput.placeholder = "–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ü–∏—é";
            showSectionSuggestions(allSections);
          } else {
            allSections = [];
            sectionInput.disabled = true;
            sectionInput.placeholder = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∫—Ü–∏–π";
            sectionSuggestions.innerHTML = `<li style="color:#999;">–ù–µ—Ç —Å–µ–∫—Ü–∏–π</li>`;
          }
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π:", err);
          showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–∫—Ü–∏–∏", "error");
        }
      }
    });

    teacherSuggestions.addEventListener("scroll", () => {
      if (
        teacherSuggestions.scrollTop + teacherSuggestions.clientHeight >=
        teacherSuggestions.scrollHeight - 10 &&
        !isLoading
      ) {
        currentPage++;
        loadTeachers(currentPage, teacherInput.value);
      }
    });

    await loadTeachers(currentPage);
  }

  function showTeacherSuggestions(input, suggestionsContainer, teachers) {
    if (!suggestionsContainer) return;
    suggestionsContainer.innerHTML = "";
    if (!Array.isArray(teachers)) {
      suggestionsContainer.innerHTML = `<li style="color:#999;">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</li>`;
      return;
    }
    if (teachers.length === 0) {
      suggestionsContainer.innerHTML = `<li style="color:#999;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>`;
      return;
    }
    teachers.forEach(teacher => {
      const li = document.createElement("li");
      li.textContent = teacher.fullName;
      li.onclick = () => {
        input.value = teacher.fullName;
        document.getElementById("teacherId").value = teacher.id;
        suggestionsContainer.innerHTML = "";
      };
      suggestionsContainer.appendChild(li);
    });
    suggestionsContainer.classList.add("show");
  }

  function showSectionSuggestions(sections) {
    const sectionSuggestions = document.getElementById("sectionSuggestions");
    sectionSuggestions.innerHTML = "";
    if (!Array.isArray(sections)) {
      sectionSuggestions.innerHTML = `<li style="color:#999;">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</li>`;
      return;
    }
    if (sections.length === 0) {
      sectionSuggestions.innerHTML = `<li style="color:#999;">–ù–µ—Ç —Å–µ–∫—Ü–∏–π</li>`;
    } else {
      sections.forEach(section => {
        const li = document.createElement("li");
        li.textContent = section.name;
        li.onclick = () => {
          document.getElementById("sectionId").value = section.id;
          document.getElementById("sectionInput").value = section.name;
          sectionSuggestions.innerHTML = "";
        };
        sectionSuggestions.appendChild(li);
      });
    }
    sectionSuggestions.classList.add("show");
  }

  // ==== –§–∏–ª—å—Ç—Ä—ã ====
  const filterTeacherInput = document.getElementById("filterTeacherInput");
  const filterSectionInput = document.getElementById("filterSectionInput");

  filterTeacherInput.addEventListener("input", () => handleFilterInput());
  filterSectionInput.addEventListener("input", () => handleFilterInput());

  function handleFilterInput() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      currentPage = 1;
      loadSchedule();
    }, 300);
  }

  let filterTimeout;

  // ==== –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ====
function sortSchedule(field) {
  if (sortField === field) {
    sortDirection = sortDirection === "asc" ? "desc" : "asc";
  } else {
    sortField = field;
    sortDirection = "asc";
  }
  updateSortIndicators();
  currentPage = 1; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  loadSchedule(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
}

  function updateSortIndicators() {
    document.querySelectorAll(".sort-indicator").forEach(el => el.textContent = "‚Üï");
    const indicator = document.getElementById(`sort-${sortField}`);
    if (indicator) {
      indicator.textContent = sortDirection === "asc" ? "‚Üë" : "‚Üì";
    }
  }

  // ==== –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ====
  async function loadSchedule() {
  try {
    const url = new URL("/api/schedule", window.location.origin);

    // –°–±–æ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    url.searchParams.append("page", currentPage);
    url.searchParams.append("limit", itemsPerPage);
    url.searchParams.append("sort", sortField);
    url.searchParams.append("order", sortDirection);

    const filterStatus = document.getElementById("filterStatus").value;
    if (filterStatus) url.searchParams.append("status", filterStatus);

    const filterDate = document.getElementById("filterDate").value || "";
    if (filterDate) url.searchParams.append("date", filterDate);

    const teacherMatch = allTeachers.find(t => t.fullName.toLowerCase() === filterTeacherInput.value.trim().toLowerCase());
    if (teacherMatch) url.searchParams.append("teacherId", teacherMatch.id);

    const sectionMatch = allFilterSections.find(s => s.name.toLowerCase() === filterSectionInput.value.trim().toLowerCase());
    if (sectionMatch) url.searchParams.append("sectionId", sectionMatch.id);

    // üîÅ –ó–∞–ø—Ä–æ—Å –∫ API
    const response = await fetch(url.toString());

    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è");

    const data = await response.json();

    // ‚úÖ –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    renderSchedule(data);
    updatePagination(data); // ‚¨ÖÔ∏è –≠—Ç–∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏...
    
  } catch (error) {
    showToast(error.message, "error");
  }
}

 function renderSchedule(data) {
  const tbody = document.getElementById("scheduleList");
  tbody.innerHTML = "";

  data.data.forEach(item => {
    const clientCount = item.clientCount || 0;
    const maxParticipants = item.maxParticipants || 1;
    const isFull = clientCount >= maxParticipants;
    const statusText = `${clientCount}/${maxParticipants}`;
    const statusClass = isFull ? 'status full' : 'status available';

    const row = `
      <tr>
        <td>${item.id}</td>
        <td>${formatDate(item.date)} ${formatTime(item.startTime)}</td>
        <td>${item.teacherName || "-"}</td>
        <td>${item.sectionName || "-"}</td>
        <td>${item.duration} —á.</td>
        <td class="${statusClass}">${statusText}</td>
        <td class="actions">
          <button onclick="viewClients(${item.id})">üëÅÔ∏è</button>
          <button onclick="editSchedule(${item.id})">‚úèÔ∏è</button>
          <button onclick="deleteSchedule(${item.id})">üóëÔ∏è</button>
        </td>
      </tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}
function updatePagination(responseData) {
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";

  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ
  const totalPages = responseData.pagination?.totalPages || 1;
  const currentPage = responseData.pagination?.currentPage || 1;

  if (totalPages <= 1) return;
  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
  const prevBtn = document.createElement("button");
  prevBtn.textContent = "‚Üê";
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => {
    if (currentPage > 1) {
      window.currentPage = currentPage - 1;
      loadSchedule();
    }
  };
  pagination.appendChild(prevBtn);

  // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === currentPage) {
      btn.classList.add("active");
      btn.disabled = true;
    }
    btn.onclick = () => {
      window.currentPage = i;
      loadSchedule();
    };
    pagination.appendChild(btn);
  }

  // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä—ë–¥"
  const nextBtn = document.createElement("button");
  nextBtn.textContent = "‚Üí";
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => {
    if (currentPage < totalPages) {
      window.currentPage = currentPage + 1;
      loadSchedule();
    }
  };
  pagination.appendChild(nextBtn);
}
  function formatDate(dateString) {
    if (!dateString) return "-";
    const date = new Date(dateString);
    return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
  }

  function formatTime(timeString) {
    if (!timeString) return "-";
    const time = new Date(`1970-01-01T${timeString}`);
    return time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // ==== –ü–∞–≥–∏–Ω–∞—Ü–∏—è ====
  function updatePagination(data) {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const totalPages = data.totalPages || 1;

    const prevButton = createPaginationButton("‚Üê", currentPage > 1, () => {
      if (currentPage > 1) {
        currentPage--;
        loadSchedule();
      }
    });
    pagination.appendChild(prevButton);

    for (let page = 1; page <= totalPages; page++) {
      const button = createPaginationButton(page, page !== currentPage, () => {
        currentPage = page;
        loadSchedule();
      });
      pagination.appendChild(button);
    }

    const nextButton = createPaginationButton("‚Üí", currentPage < totalPages, () => {
      if (currentPage < totalPages) {
        currentPage++;
        loadSchedule();
      }
    });
    pagination.appendChild(nextButton);
  }

  function createPaginationButton(text, enabled, onClick) {
    const button = document.createElement("button");
    button.textContent = text;
    button.disabled = !enabled;
    button.onclick = onClick;
    return button;
  }

  // ==== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ====
  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    document.getElementById("toastContainer").appendChild(toast);
    setTimeout(() => {
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }, 100);
  }

  // ==== –ö–ª–∏–µ–Ω—Ç—ã ====
  function viewClients(scheduleId) {
    const modal = document.getElementById("viewClientsModal");
    const overlay = document.getElementById("viewClientsOverlay");
    const clientList = document.getElementById("clientList");
    modal.style.display = "block";
    overlay.style.display = "block";

    fetch(`/api/schedule/${scheduleId}/clients`, { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        clientList.innerHTML = "";
        if (data.data?.length > 0) {
          data.data.forEach(client => {
            const li = document.createElement("li");
            li.textContent = client.full_name;
            clientList.appendChild(li);
          });
        } else {
          clientList.innerHTML = `<li style="color:#999;">–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</li>`;
        }
      })
      .catch(err => {
        clientList.innerHTML = `<li style="color:red;">${err.message}</li>`;
      });
  }

  function closeViewClients() {
    document.getElementById("viewClientsModal").style.display = "none";
    document.getElementById("viewClientsOverlay").style.display = "none";
    document.getElementById("clientList").innerHTML = "";
  }

  document.getElementById("viewClientsOverlay").addEventListener("click", closeViewClients);

  // ==== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ ====
async function editSchedule(id) {
  try {
    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    const response = await fetch(`/api/schedule/${id}`, { credentials: "include" });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    const result = await response.json();
    if (!result?.success || !result?.data) throw new Error("Invalid server response");
    
    const item = result.data;
    console.log("API Response:", item); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

    // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById("formTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å";
    document.getElementById("saveButton").textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
    document.getElementById("saveButton").onclick = () => saveSchedule(id);
    document.getElementById("scheduleId").value = id;

    // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
    const dateTimeInput = document.getElementById("dateTime");
    dateTimeInput.value = ""; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    if (item.date && item.startTime) {
      try {
        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ (—É–¥–∞–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –µ—Å—Ç—å)
        const normalizedTime = item.startTime.split(':').slice(0, 2).join(':');
        
        // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç Date
        const dateString = `${item.date}T${normalizedTime}`;
        const parsedDate = new Date(dateString);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
        if (isNaN(parsedDate.getTime())) {
          console.error("Invalid date:", dateString);
          throw new Error("Invalid date format");
        }
        
        // –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        const timezoneOffset = parsedDate.getTimezoneOffset() * 60000;
        const localDate = new Date(parsedDate.getTime() - timezoneOffset);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è input[type="datetime-local"]
        const formattedDate = localDate.toISOString().slice(0, 16);
        dateTimeInput.value = formattedDate;
      } catch (dateError) {
        console.error("Date processing error:", dateError);
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º
      }
    }

    // 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    document.getElementById("duration").value = item.duration || "1";

    // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    const teacherInput = document.getElementById("teacherInput");
    const teacherIdInput = document.getElementById("teacherId");
    
    teacherInput.value = item.teacherName || "";
    teacherIdInput.value = item.teacherId || "";
    teacherInput.placeholder = "";

    // 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ–∫—Ü–∏–∏
    const sectionInput = document.getElementById("sectionInput");
    const sectionIdInput = document.getElementById("sectionId");
    
    // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–∫—Ü–∏–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    try {
      await loadSectionsForTeacher(item.teacherId);
      sectionInput.value = item.sectionName || "";
      sectionIdInput.value = item.sectionId || "";
      sectionInput.placeholder = "";
      sectionInput.disabled = false;
    } catch (e) {
      console.error("Failed to load sections:", e);
      sectionInput.value = "";
      sectionInput.placeholder = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π";
      sectionInput.disabled = true;
    }

    // 7. –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏
    highlightEditingRow(id);

  } catch (error) {
    console.error("Edit schedule failed:", error);
    showToast(`–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, "error");
  }
}
async function loadSectionsForTeacher(teacherId) {
  const sectionInput = document.getElementById("sectionInput");
  const sectionSuggestions = document.getElementById("sectionSuggestions");
  const sectionIdInput = document.getElementById("sectionId");

  try {
    const response = await fetch(`/api/teachers/${teacherId}/sections`, {
      credentials: "include"
    });
    
    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π");
    
    const { data: sections } = await response.json();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ–∫—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    allSections = sections || [];
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ —Å–µ–∫—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ–∫—Ü–∏–∏
    sectionInput.disabled = allSections.length === 0;
    
    return allSections;
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π:", error);
    sectionInput.disabled = true;
    return [];
  }
}

function highlightEditingRow(id) {
  // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
  document.querySelectorAll("#scheduleList tr").forEach(row => {
    row.classList.remove("editing");
  });
  
  // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –µ—ë
  const targetRow = Array.from(document.querySelectorAll("#scheduleList tr")).find(
    row => parseInt(row.cells[0].textContent) === id
  );
  
  if (targetRow) {
    targetRow.classList.add("editing");
    targetRow.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}
  async function saveSchedule(id) {
    const dateTime = document.getElementById("dateTime").value;
    const teacherId = document.getElementById("teacherId").value;
    const sectionId = document.getElementById("sectionId").value;
    const duration = document.getElementById("duration").value;

    if (!dateTime || !teacherId || !sectionId || !duration) {
      showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "error");
      return;
    }

    try {
      const conflictRes = await fetch("/api/schedule/check", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ teacherId, dateTime, duration, excludeId: id }),
        credentials: "include"
      });
      const conflictData = await conflictRes.json();
      if (conflictData.conflict) {
        showToast("–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è", "error");
        return;
      }

      const res = await fetch(`/api/schedule/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dateTime, duration, sectionId, teacherId }),
        credentials: "include"
      });

      const result = await res.json();
      if (!res.ok) throw new Error(result.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");

      showToast("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
      clearEditing();
      clearForm();
      loadSchedule();
    } catch (error) {
      showToast(error.message, "error");
    }
  }

  async function deleteSchedule(id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
    try {
      const res = await fetch(`/api/schedule/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      const result = await res.json();
      if (!res.ok) throw new Error(result.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
      showToast("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞");
      loadSchedule();
    } catch (error) {
      showToast(error.message, "error");
    }
  }

 async function addSchedule() {
  const dateTime = document.getElementById("dateTime").value;
  const teacherId = document.getElementById("teacherId").value;
  const sectionId = document.getElementById("sectionId").value;
  const duration = document.getElementById("duration").value;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
  if (!dateTime || !teacherId || !sectionId || !duration) {
    showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è", "error");
    return;
  }

  const selectedDate = new Date(dateTime);
  const now = new Date();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
  if (selectedDate < now) {
    showToast("–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ—à–µ–¥—à—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è", "error");
    return;
  }

  try {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    const conflictRes = await fetch("/api/schedule/check", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ teacherId, dateTime, duration }),
      credentials: "include"
    });

    const conflictData = await conflictRes.json();

    if (conflictData.conflict) {
      showToast("–£ —ç—Ç–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∑–∞–Ω—è—Ç–∏–µ –≤ —ç—Ç–æ –≤—Ä–µ–º—è", "error");
      return;
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    const res = await fetch("/api/schedule", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ dateTime, duration, sectionId, teacherId }),
      credentials: "include"
    });

    const result = await res.json();

    if (!res.ok) {
      throw new Error(result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è");
    }

    showToast("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", "success");
    clearForm();
    loadSchedule();

  } catch (error) {
    showToast(error.message, "error");
  }
}

  function clearEditing() {
    document.querySelectorAll(".schedule-table tr.editing").forEach(row => row.classList.remove("editing"));
  }

  function clearForm() {
    document.getElementById("formTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ";
    document.getElementById("saveButton").textContent = "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å";
    document.getElementById("saveButton").onclick = addSchedule;
    document.getElementById("dateTime").value = "";
    document.getElementById("teacherId").value = "";
    document.getElementById("teacherInput").value = "";
    document.getElementById("sectionId").value = "";
    document.getElementById("sectionInput").value = "";
    document.getElementById("duration").value = "";
  }

  function clearFilters() {
    document.getElementById("filterDate").value = "";
    document.getElementById("filterTeacherInput").value = "";
    document.getElementById("filterTeacherId").value = "";
    document.getElementById("filterSectionInput").value = "";
    document.getElementById("filterSectionId").value = "";
    document.getElementById("filterStatus").value = "";
    currentPage = 1;
    loadSchedule();
  }
    // === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è ===
  let currentPageTeachers = 1;
  const limitTeachers = 10;
  let isLoadingTeachers = false;
  let localTeachers = [];

  // === –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π ===
  async function loadTeachers(page = 1, search = "") {
    if (isLoadingTeachers) return;
    isLoadingTeachers = true;

    try {
      const response = await fetch(`/api/teachers?page=${page}&limit=${limitTeachers}&search=${encodeURIComponent(search)}`, {
        method: "GET",
        credentials: "include"
      });

      if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π");

      const data = await response.json();
      let teachers = [];

      if (Array.isArray(data)) {
        teachers = data;
      } else if (Array.isArray(data.data)) {
        teachers = data.data;
      } else {
        throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");
      }

      if (page === 1) {
        localTeachers = [...teachers];
        document.getElementById("teacherSuggestions").innerHTML = "";
      } else {
        localTeachers = [...localTeachers, ...teachers];
      }

      showTeacherSuggestions(localTeachers);

    } catch (error) {
      showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π: " + error.message, "error");
    } finally {
      isLoadingTeachers = false;
    }
  }

  // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π ===
  function showTeacherSuggestions(teachers) {
    const teacherSuggestions = document.getElementById("teacherSuggestions");
    teacherSuggestions.innerHTML = "";

    if (!Array.isArray(teachers)) {
      teacherSuggestions.innerHTML = `<li style="color:#999;">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</li>`;
      return;
    }

    if (teachers.length === 0) {
      teacherSuggestions.innerHTML = `<li style="color:#999;">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</li>`;
      return;
    }

    teachers.forEach(teacher => {
      const li = document.createElement("li");
      li.textContent = teacher.fullName;
      li.onclick = () => {
        document.getElementById("teacherInput").value = teacher.fullName;
        document.getElementById("teacherId").value = teacher.id;
        teacherSuggestions.classList.remove("show");

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∫—Ü–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        loadSectionsForTeacher(teacher.id);
      };
      teacherSuggestions.appendChild(li);
    });

    teacherSuggestions.classList.add("show");
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∫—Ü–∏–π –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è ===
  async function loadSectionsForTeacher(teacherId) {
  const sectionInput = document.getElementById("sectionInput");
  const sectionSuggestions = document.getElementById("sectionSuggestions");
  const sectionIdInput = document.getElementById("sectionId");

  sectionInput.disabled = false;
  sectionInput.value = "";
  sectionIdInput.value = "";
  sectionSuggestions.innerHTML = "<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>";

  try {
    const res = await fetch(`/api/teachers/${teacherId}/sections`, {
      method: "GET",
      credentials: "include"
    });

    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π");

    const data = await res.json();
    let sections = Array.isArray(data) ? data : data.data || [];

    if (sections.length === 0) {
      sectionSuggestions.innerHTML = `<li style="color:#999;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∫—Ü–∏–π</li>`;
      sectionInput.disabled = true;
      return;
    }

    showSectionSuggestions(sections);

  } catch (error) {
    sectionSuggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞: ${error.message}</li>`;
    sectionInput.disabled = true;
  }
}

  // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è ===
  function showSectionSuggestions(sections) {
    const sectionSuggestions = document.getElementById("sectionSuggestions");
    const sectionInput = document.getElementById("sectionInput");
    sectionSuggestions.innerHTML = "";

    if (!Array.isArray(sections)) {
      sectionSuggestions.innerHTML = `<li style="color:#999;">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</li>`;
      return;
    }

    if (sections.length === 0) {
      sectionSuggestions.innerHTML = `<li style="color:#999;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∫—Ü–∏–π</li>`;
      return;
    }

    sections.forEach(section => {
      const li = document.createElement("li");
      li.textContent = section.name;
      li.onclick = () => {
        sectionInput.value = section.name;
        document.getElementById("sectionId").value = section.id;
        sectionSuggestions.innerHTML = "";
        sectionSuggestions.classList.remove("show");
      };
      sectionSuggestions.appendChild(li);
    });

    sectionSuggestions.classList.add("show");
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π ===
  function initAutocomplete() {
    const teacherInput = document.getElementById("teacherInput");
    const teacherSuggestions = document.getElementById("teacherSuggestions");

    // –°–±—Ä–æ—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–∏—Å–∫–µ
    teacherInput.addEventListener("input", (e) => {
      currentPageTeachers = 1;
      loadTeachers(currentPageTeachers, e.target.value);
    });

    // –ü–æ–¥–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
    teacherSuggestions.addEventListener("scroll", () => {
      if (
        teacherSuggestions.scrollTop + teacherSuggestions.clientHeight >=
        teacherSuggestions.scrollHeight - 10 &&
        !isLoadingTeachers
      ) {
        currentPageTeachers++;
        loadTeachers(currentPageTeachers, teacherInput.value);
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".autocomplete-wrapper")) {
        teacherSuggestions.classList.remove("show");
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadTeachers(currentPageTeachers);
  }

  // === –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===
  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    document.getElementById("toastContainer").appendChild(toast);
    setTimeout(() => {
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }, 100);
  }

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  document.addEventListener("DOMContentLoaded", () => {
    initAutocomplete();
  });
  // === –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ñ–æ–∫—É—Å–µ ===
  filterTeacherInput.addEventListener("focus", async () => {
    if (allTeachers.length === 0) await loadAllTeachers();
    showFilterTeacherSuggestions(allTeachers);
  });

  filterSectionInput.addEventListener("focus", async () => {
    if (allFilterSections.length === 0) await loadAllFilterSections();
    showFilterSectionSuggestions(allFilterSections);
  });

  // === –í–≤–æ–¥ –≤ –ø–æ–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ ===
  filterTeacherInput.addEventListener("input", () => handleFilterInput());
  filterSectionInput.addEventListener("input", () => handleFilterInput());

  function handleFilterInput() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      currentPage = 1;
      loadSchedule();
    }, 300);
  }


  // === –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ ===
  async function loadAllTeachers() {
    try {
      const res = await fetch("/api/teachers", { credentials: "include" });
      const data = await res.json();
      allTeachers = Array.isArray(data) ? data : Array.isArray(data.data) ? data.data : [];
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π:", e);
    }
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∫—Ü–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ ===
  async function loadAllFilterSections() {
    try {
      const res = await fetch("/api/sections", { credentials: "include" });
      const data = await res.json();
      allFilterSections = Array.isArray(data) ? data : Array.isArray(data.data) ? data.data : [];
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π:", e);
    }
  }

  // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∏–ª—å—Ç—Ä–µ ===
  function showFilterTeacherSuggestions(teachers) {
    filterTeacherSuggestions.innerHTML = "";
    if (!Array.isArray(teachers) || teachers.length === 0) {
      filterTeacherSuggestions.innerHTML = `<li style="color:#999; text-align:center">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</li>`;
      return;
    }
    teachers.forEach(teacher => {
      const li = document.createElement("li");
      li.textContent = teacher.fullName;
      li.onclick = () => {
        document.getElementById("filterTeacherId").value = teacher.id;
        filterTeacherInput.value = teacher.fullName;
        filterTeacherSuggestions.innerHTML = "";
        handleFilterInput();
      };
      filterTeacherSuggestions.appendChild(li);
    });
    filterTeacherSuggestions.classList.add("show");
  }

  // === –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä–µ ===
  function showFilterSectionSuggestions(sections) {
    filterSectionSuggestions.innerHTML = "";
    if (!Array.isArray(sections) || sections.length === 0) {
      filterSectionSuggestions.innerHTML = `<li style="color:#999; text-align:center">–°–µ–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</li>`;
      return;
    }
    sections.forEach(section => {
      const li = document.createElement("li");
      li.textContent = section.name;
      li.onclick = () => {
        document.getElementById("filterSectionId").value = section.id;
        filterSectionInput.value = section.name;
        filterSectionSuggestions.innerHTML = "";
        handleFilterInput();
      };
      filterSectionSuggestions.appendChild(li);
    });
    filterSectionSuggestions.classList.add("show");
  }

  // === –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ ===
  function clearFilters() {
    document.getElementById("filterDate").value = "";
    filterTeacherInput.value = "";
    document.getElementById("filterTeacherId").value = "";
    filterSectionInput.value = "";
    document.getElementById("filterSectionId").value = "";
    document.getElementById("filterStatus").value = "";
    currentPage = 1;
    loadSchedule();
  }

  // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ===
  async function loadSectionsForTeacher(teacherId) {
  const sectionInput = document.getElementById("sectionInput");
  const sectionSuggestions = document.getElementById("sectionSuggestions");
  const sectionIdInput = document.getElementById("sectionId");

  sectionInput.disabled = false;
  sectionInput.value = "";
  sectionIdInput.value = "";
  sectionSuggestions.innerHTML = "<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>";

  try {
    const res = await fetch(`/api/teachers/${teacherId}/sections`, {
      method: "GET",
      credentials: "include"
    });

    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π");

    const data = await res.json();
    let sections = Array.isArray(data) ? data : data.data || [];

    if (sections.length === 0) {
      sectionSuggestions.innerHTML = `<li style="color:#999;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∫—Ü–∏–π</li>`;
      sectionInput.disabled = true;
      return;
    }

    showSectionSuggestions(sections); // –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è

  } catch (error) {
    sectionSuggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞: ${error.message}</li>`;
    sectionInput.disabled = true;
  }
}
  // === –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π ===
  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    document.getElementById("toastContainer").appendChild(toast);
    setTimeout(() => {
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }, 100);
  }
   function updateSortIndicators() {
    document.querySelectorAll(".sort-indicator").forEach(el => el.textContent = "‚Üï");
    const indicator = document.getElementById(`sort-${sortField}`);
    if (indicator) {
      indicator.textContent = sortDirection === "asc" ? "‚Üë" : "‚Üì";
    }
  }

  // === –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ===
  function sortSchedule(field) {
    // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ç–æ –∂–µ –ø–æ–ª–µ ‚Äî –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    if (sortField === field) {
      sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
      // –ò–Ω–∞—á–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      sortField = field;
      sortDirection = "asc";
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    updateSortIndicators();

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    currentPage = 1;
    loadSchedule();
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π ===
async function loadSchedule() {
  try {
    const url = new URL("/api/schedule", window.location.origin);

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    url.searchParams.append("page", currentPage);
    url.searchParams.append("limit", itemsPerPage);
    url.searchParams.append("sort", sortField);
    url.searchParams.append("order", sortDirection);

    const filterStatus = document.getElementById("filterStatus").value;
    if (filterStatus) url.searchParams.append("status", filterStatus);

    const filterDate = document.getElementById("filterDate").value;
    if (filterDate) url.searchParams.append("date", filterDate);

    const filterTeacherInput = document.getElementById("filterTeacherInput");
    const filterTeacher = filterTeacherInput.value.trim().toLowerCase();

    const teacherMatch = allTeachers.find(t => t.fullName.toLowerCase() === filterTeacher);
    if (teacherMatch) url.searchParams.append("teacherId", teacherMatch.id);

    const filterSectionInput = document.getElementById("filterSectionInput");
    const filterSection = filterSectionInput.value.trim().toLowerCase();

    const sectionMatch = allFilterSections.find(s => s.name.toLowerCase() === filterSection);
    if (sectionMatch) url.searchParams.append("sectionId", sectionMatch.id);

    const response = await fetch(url.toString());
    const data = await response.json();

    renderSchedule(data);
    updatePagination(data); // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é

  } catch (error) {
    showToast(error.message, "error");
  }
}

  // === –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π ===
function renderSchedule(data) {
  const tbody = document.getElementById("scheduleList");
  tbody.innerHTML = "";

  if (!data.data || data.data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</td></tr>`;
    return;
  }

  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ/–≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –¥—Ä—É–≥–∏–º –ø–æ–ª—è–º (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
  const sortedData = [...data.data].sort((a, b) => {
    const dir = sortDirection === "asc" ? 1 : -1;
    switch (sortField) {
      case "id":
        return dir * (a.id - b.id);
      case "date":
        return dir * (new Date(a.date + "T" + a.startTime) - new Date(b.date + "T" + b.startTime));
      case "teacher":
        return dir * a.teacherName.localeCompare(b.teacherName);
      case "section":
        return dir * a.sectionName.localeCompare(b.sectionName);
      case "duration":
        return dir * (a.duration - b.duration);
      case "status":
        const statusA = `${a.clientCount}/${a.maxParticipants}`;
        const statusB = `${b.clientCount}/${b.maxParticipants}`;
        return dir * statusA.localeCompare(statusB);
      default:
        return 0;
    }
  });

  sortedData.forEach(item => {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    const isFull = item.clientCount >= item.maxParticipants;
    const statusText = `${item.clientCount}/${item.maxParticipants}`;
    const statusClass = isFull ? 'full' : 'available';

    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML-—Å—Ç—Ä–æ–∫—É
    const row = `
      <tr>
        <td>${item.id}</td>
        <td>${formatDate(item.date)} ${formatTime(item.startTime)}</td>
        <td>${item.teacherName || "-"}</td>
        <td>${item.sectionName || "-"}</td>
        <td>${item.duration} —á.</td>
        <!-- –í–æ—Ç —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞—à —Å—Ç–∞—Ç—É—Å -->
        <td class="status ${statusClass}">${statusText}</td>
        <td class="actions">
          <button onclick="viewClients(${item.id})">üëÅÔ∏è</button>
          <button onclick="editSchedule(${item.id})">‚úèÔ∏è</button>
          <button onclick="deleteSchedule(${item.id})">üóëÔ∏è</button>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

  // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
  function formatDate(dateString) {
    if (!dateString) return "-";
    const date = new Date(dateString);
    return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
  }

  function formatTime(timeString) {
    if (!timeString) return "-";
    const time = new Date(`1970-01-01T${timeString}`);
    return time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    document.getElementById("toastContainer").appendChild(toast);
    setTimeout(() => {
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }, 100);
  }
 function filterSchedule() {
  currentPage = 1;
  loadSchedule();
}
function handleTeacherInput(query) {
  clearTimeout(teacherDebounce);
  const input = document.getElementById("teacherInput");
  const suggestions = document.getElementById("teacherSuggestions");

  if (!query.trim()) {
    suggestions.classList.remove("show");
    return;
  }

  teacherDebounce = setTimeout(async () => {
    try {
      const res = await fetch(`/api/teachers?search=${encodeURIComponent(query)}`, {
        method: 'GET',
        credentials: 'include'
      });

      if (!res.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${res.status}`);
      }

      const data = await res.json();
      const teachers = Array.isArray(data) ? data : (data.data || []);

      suggestions.innerHTML = "";

      if (!teachers.length) {
        suggestions.insertAdjacentHTML("beforeend", `<li>–ù–µ –Ω–∞–π–¥–µ–Ω–æ</li>`);
        suggestions.classList.add("show");
        return;
      }

      teachers.forEach(teacher => {
        const li = document.createElement("li");
        li.textContent = `${teacher.full_name}`;
        li.onclick = () => {
          input.value = teacher.full_name;
          document.getElementById("teacherId").value = teacher.id;
          suggestions.classList.remove("show");
        };
        suggestions.appendChild(li);
      });

      suggestions.classList.add("show");
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:", err);
      suggestions.innerHTML = `<li style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>`;
      suggestions.classList.add("show");
    }
  }, 300);
}

// === –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –≤–Ω–µ –∫–ª–∏–∫–∞ ===
function setupOutsideClickClose(wrapperClass, suggestionsId) {
  document.addEventListener("click", function (event) {
    const wrapper = document.querySelector(wrapperClass);
    const suggestions = document.querySelector(suggestionsId);
    if (wrapper && !wrapper.contains(event.target)) {
      suggestions.classList.remove("show");
    }
  });
}

setupOutsideClickClose(".autocomplete-wrapper.teacher", "#teacherSuggestions");
</script>
</body>
</html>