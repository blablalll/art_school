<!-- public/teachers.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏ - –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
<div class="header">
  <img src="/pictures/logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height: 40px; margin-right: 15px;" />
  <h1>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏</h1>
  <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–∞–≤–∞ -->
  <div class="user-greeting" id="userGreeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Å—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
</div>

  
  <!-- –ú–µ–Ω—é -->
  <nav class="menu">
    <a href="/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
    <a href="/clients.html">–ö–ª–∏–µ–Ω—Ç—ã</a>
    <a href="/teachers.html" class="active">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</a>
    <a href="/abonim.html">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</a>
    <a href="/sections.html">–°–µ–∫—Ü–∏–∏</a>
    <a href="/records.html">–ó–∞–ø–∏—Å–∏</a>
    <a href="/login.html" class="logout-button">–í—ã–π—Ç–∏</a>
  </nav>
  
  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="container">
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) -->
    <div id="toastContainer"></div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ -->
    <div class="main-content">
      <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è -->
      <div class="teacher-form">
        <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h3>
        <input type="hidden" id="teacherId" />
        
        <div class="form-grid">
          <div class="input-group">
            <label for="fullName">–§–ò–û</label>
            <input type="text" id="fullName" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û" required />
          </div>
          
          <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –≤—ã–±–æ—Ä–∞ —Å–µ–∫—Ü–∏–π -->
          <div class="input-group autocomplete-wrapper">
            <label for="sectionInput">–°–µ–∫—Ü–∏–∏</label>
            <input type="text" id="sectionInput" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" autocomplete="off" />
            <ul id="sectionSuggestions" class="autocomplete-list"></ul>
            <div id="selectedSections" class="selected-tags"></div>
            <input type="hidden" id="sectionIds" />
          </div>
          
          <div class="input-group">
            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="phone" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" required />
          </div>
          
          <div class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="–í–≤–µ–¥–∏—Ç–µ email" required />
          </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
        <div style="margin-top: 10px;">
          <button id="saveButton" onclick="addTeacher()" style="background-color: var(--secondary); color: black;">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</button>
        </div>
      </div>
      
<!-- –§–∏–ª—å—Ç—Ä –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π -->
<div class="filter-section small-filter">
  <div class="filter-header">
    <h3>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</h3>
  </div>
  <div class="filter-row">
    <div class="input-group autocomplete-wrapper" style="flex: 2;">
      <input type="text" id="filterName" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û" oninput="filterTeachers()" />
    </div>
    <div class="input-group autocomplete-wrapper" style="flex: 2;">
      <input type="text" id="filterSectionInput" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å–µ–∫—Ü–∏—è–º" autocomplete="off" />
      <ul id="filterSectionSuggestions" class="autocomplete-list"></ul>
      <div id="selectedFilterSections" class="selected-tags"></div>
      <input type="hidden" id="filterSectionIds" />
    </div>
    <button onclick="location.reload()" class="reset-button" style="height: 40px; margin-top: 18px;">
  –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
</button>
  </div>
</div>
      
      <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π -->
    <table class="teachers-table">
  <thead>
    <tr>
      <th onclick="sortTeachers('id')">
        ID 
        <span class="sort-indicator" id="sort-id">‚Üï</span>
      </th>
      <th onclick="sortTeachers('fullName')">
        –§–ò–û 
        <span class="sort-indicator" id="sort-fullName">‚Üï</span>
      </th>
      <th>–°–µ–∫—Ü–∏–∏</th>
      <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
      <th>Email</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody id="teachersList"></tbody>
</table>
      
      <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <script>
    function checkAuth() {
  if (!sessionStorage.getItem("isAuthenticated")) {
    window.location.href = "/login.html";
  }
}
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function checkAuth() {
      if (!sessionStorage.getItem("isAuthenticated")) {
        window.location.href = "/login.html";
      }
    }
    function showTeacherSuggestions(input, suggestionsContainer, teachers) {
  if (!suggestionsContainer) return;
  suggestionsContainer.innerHTML = "";

  if (teachers.length === 0) {
    suggestionsContainer.innerHTML = `<li style="color:#999; text-align:center">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>`;
    return;
  }

  teachers.forEach(teacher => {
    const li = document.createElement("li");
    li.textContent = teacher.fullName;
    li.onclick = () => {
      input.value = teacher.fullName;
      document.getElementById("teacherId").value = teacher.id;
      suggestionsContainer.innerHTML = "";
    };
    suggestionsContainer.appendChild(li);
  });

  suggestionsContainer.classList.add("show");
}
document.addEventListener("DOMContentLoaded", () => {
  checkAuth();
  initPhoneInput();
  updateSortIndicators();
  loadTeachers();
  initAutocomplete();
  initSectionFilterAutocomplete();
});
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function initPhoneInput() {
      const phoneInput = document.getElementById("phone");
      phoneInput.addEventListener("input", function(e) {
        let phone = e.target.value.replace(/\D/g, '');
        if (!phone.startsWith('7')) phone = '7' + phone;
        phone = phone.substring(0, 11);
        e.target.value = phone;
      });
    }
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
let currentPage = 1;
const itemsPerPage = 10;
let sortField = "id";
let sortDirection = "asc";
let selectedSections = [];
let filterSectionId = null;
let allSections = [];

    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
async function loadTeachers() {
  try {
    const url = new URL("/api/teachers", window.location.origin);
    url.searchParams.append("page", currentPage);
    url.searchParams.append("limit", itemsPerPage);
    url.searchParams.append("sort", sortField);
    url.searchParams.append("order", sortDirection);
    
    const nameFilter = document.getElementById("filterName").value;
    if (nameFilter) {
      url.searchParams.append("search", nameFilter);
    }
    
    if (filterSectionId) {
      url.searchParams.append("sectionId", filterSectionId);
    }

    const response = await fetch(url, { credentials: "include" });
    if (response.status === 401) {
      sessionStorage.removeItem("isAuthenticated");
      window.location.href = "/login.html";
      return;
    }

    const data = await response.json();
    if (!response.ok) throw new Error(data.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");

    renderTeachers(data);
    updatePagination(data);
  } catch (error) {
    showToast(error.message, "error");
  }
}


async function loadSectionOptions() {
  try {
    const res = await fetch("/api/sections?limit=100", { credentials: "include" });
    const data = await res.json();
    if (res.ok && Array.isArray(data.data)) {
      allSections = data.data;
      const select = document.getElementById("filterSectionSelect");
      select.innerHTML = '<option value="">–í—Å–µ —Å–µ–∫—Ü–∏–∏</option>';
      allSections.forEach(section => {
        const option = document.createElement("option");
        option.value = section.id;
        option.textContent = section.name;
        select.appendChild(option);
      });
    } else {
      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ–∫—Ü–∏–π");
    }
  } catch (error) {
    showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π: " + error.message, "error");
  }
  document.addEventListener("DOMContentLoaded", () => {
  checkAuth();
  initPhoneInput();
  updateSortIndicators();
  loadTeachers();
  initAutocomplete();
  initSectionFilterAutocomplete(); // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –µ—Å—Ç—å
  loadSectionOptions(); // ‚Üê –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
  
});
}
async function initSectionFilterAutocomplete() {
  const input = document.getElementById("filterSectionInput");
  const suggestions = document.getElementById("filterSectionSuggestions");
  let allSections = [];
  
  async function loadAllSections() {
    const res = await fetch("/api/sections?limit=1000", { credentials: "include" }); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç
    const data = await res.json();
    if (res.ok) allSections = data.data || [];
  }
  
  function showSuggestions(filteredSections) {
    suggestions.innerHTML = "";
    if (filteredSections.length === 0) {
      suggestions.innerHTML = `<li style="color:#999; text-align:center">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>`;
    } else {
      filteredSections.forEach(section => {
        const li = document.createElement("li");
        li.textContent = section.name;
        li.onclick = () => {
          filterSectionId = section.id;
          document.getElementById("selectedFilterSections").innerHTML = 
            `<span class="tag">${section.name} <button onclick="clearSectionFilter()">√ó</button></span>`;
          document.getElementById("filterSectionIds").value = section.id;
          input.value = "";
          suggestions.classList.remove("show");
          filterTeachers();
        };
        suggestions.appendChild(li);
      });
    }
    suggestions.classList.add("show");
  }
  
  input.addEventListener("input", async (e) => {
    if (allSections.length === 0) await loadAllSections();
    const value = e.target.value.trim().toLowerCase();
    const filtered = allSections.filter(s => s.name.toLowerCase().includes(value));
    showSuggestions(filtered);
  });
  
  input.addEventListener("focus", async () => {
    if (allSections.length === 0) await loadAllSections();
    showSuggestions(allSections);
  });
  
  document.addEventListener("click", (e) => {
    if (!input.parentElement.contains(e.target)) {
      suggestions.classList.remove("show");
    }
  });
  
  await loadAllSections();
}
async function initTeacherAutocomplete() {
  const input = document.getElementById("teacherInput");
  const suggestions = document.getElementById("teacherSuggestions");

  try {
    // –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã page –∏ limit
    const res = await fetch("/api/teachers?page=1&limit=100", { credentials: "include" });
    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π");

    const data = await res.json();
    const teachers = data.data || [];

    // –¢–µ–ø–µ—Ä—å –≤ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—É–¥–µ—Ç –¥–æ 100 –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
    showTeacherSuggestions(input, suggestions, teachers);
  } catch (error) {
    showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π: " + error.message, "error");
  }
}
// –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å–µ–∫—Ü–∏—è–º
function clearSectionFilter() {
  filterSectionId = null;
  document.getElementById("selectedFilterSections").innerHTML = "";
  document.getElementById("filterSectionIds").value = "";
  document.getElementById("filterSectionInput").value = "";
  filterTeachers();
}

// –í —Ñ—É–Ω–∫—Ü–∏–∏ clearFilters –¥–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ clearSectionFilter():
function clearFilters() {
  document.getElementById("filterName").value = "";
  clearSectionFilter();
  currentPage = 1;
  loadTeachers();
}
async function initAutocomplete() {
  const input = document.getElementById("sectionInput");
  const suggestions = document.getElementById("sectionSuggestions");
  let allSections = [];
  
  
  function showSuggestions(filteredSections) {
    suggestions.innerHTML = "";
    if (filteredSections.length === 0) {
      suggestions.innerHTML = `<li style="color:#999; text-align:center">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>`;
    } else {
      filteredSections.forEach(section => {
        const li = document.createElement("li");
        li.textContent = section.name;
        li.onclick = () => {
          if (!selectedSections.some(s => s.id === section.id)) {
            selectedSections.push(section);
            document.getElementById("selectedSections").innerHTML += 
              `<span class="tag">${section.name} <button onclick="removeSection(${section.id})">√ó</button></span>`;
            document.getElementById("sectionIds").value = selectedSections.map(s => s.id).join(',');
          }
          input.value = "";
          suggestions.classList.remove("show");
        };
        suggestions.appendChild(li);
      });
    }
    suggestions.classList.add("show");
  }
  
  input.addEventListener("input", async (e) => {
    if (allSections.length === 0) await loadAllSections();
    const value = e.target.value.trim().toLowerCase();
    const filtered = allSections.filter(s => s.name.toLowerCase().includes(value));
    showSuggestions(filtered);
  });
  
  input.addEventListener("focus", async () => {
    if (allSections.length === 0) await loadAllSections();
    showSuggestions(allSections);
  });
  
  document.addEventListener("click", (e) => {
    if (!document.querySelector(".autocomplete-wrapper").contains(e.target)) {
      suggestions.classList.remove("show");
    }
  });
  
  await loadAllSections();
}
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
    function renderTeachers(data) {
  const tbody = document.getElementById("teachersList");
  tbody.innerHTML = "";
  
  if (!data.data || !Array.isArray(data.data) || data.data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è—Ö</td></tr>`;
    updatePagination(data);
    return;
  }
  
  data.data.forEach(teacher => {
    const row = `
      <tr>
        <td>${teacher.id}</td>
        <td>${teacher.fullName || "-"}</td>
        <td>${teacher.sectionNames?.join(', ') || "-"}</td>
        <td>${formatPhone(teacher.phone)}</td>
        <td>${teacher.email || "-"}</td>
        <td class="actions">
          <button onclick="editTeacher(${teacher.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button onclick="deleteTeacher(${teacher.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
  
  updatePagination(data);
}
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    async function addTeacher() {
      const fullName = document.getElementById("fullName").value.trim();
      let phone = document.getElementById("phone").value.replace(/\D/g, '');
      const email = document.getElementById("email").value.trim();
      const sectionIds = document.getElementById("sectionIds").value.split(',').filter(Boolean);
      
      if (!fullName) return showToast("–í–≤–µ–¥–∏—Ç–µ –§–ò–û", "error");
      if (phone.length !== 11) return showToast("–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä", "error");
      if (email && !validateEmail(email)) return showToast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email", "error");
      
      try {
        const response = await fetch("/api/teachers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fullName, phone, email, sectionIds }),
          credentials: "include"
        });
        
        const result = await response.json();
        if (!response.ok) throw new Error(result.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        
        showToast(`–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å "${fullName}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω`);
        clearForm();
        loadTeachers();
      } catch (error) {
        showToast(error.message, "error");
      }
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
   async function editTeacher(id) {
  try {
    // –°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    clearEditing();
    clearForm();
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    const response = await fetch(`/api/teachers/${id}`, { credentials: "include" });
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è");
    }
    
    const teacher = await response.json();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
    if (!teacher.data) {
      throw new Error("–î–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã");
    }
    
    const teacherData = teacher.data;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    document.getElementById("fullName").value = teacherData.fullName || "";
    document.getElementById("phone").value = teacherData.phone || "";
    document.getElementById("email").value = teacherData.email || "";
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–µ–∫—Ü–∏–∏
    selectedSections = [];
    document.getElementById("selectedSections").innerHTML = "";
    document.getElementById("sectionIds").value = "";
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–∫—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (teacherData.sectionIds && teacherData.sectionIds.length > 0) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –∏ IDs –∏ –Ω–∞–∑–≤–∞–Ω–∏—è
      if (!teacherData.sectionNames || teacherData.sectionNames.length !== teacherData.sectionIds.length) {
        console.warn("–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É IDs —Å–µ–∫—Ü–∏–π –∏ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏");
      }
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–∫—Ü–∏–∏
      teacherData.sectionIds.forEach((sectionId, index) => {
        const sectionName = teacherData.sectionNames?.[index] || `–°–µ–∫—Ü–∏—è ${sectionId}`;
        selectedSections.push({ id: sectionId, name: sectionName });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥ —Å–µ–∫—Ü–∏–∏
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.innerHTML = `${sectionName} <button onclick="removeSection(${sectionId})">√ó</button>`;
        document.getElementById("selectedSections").appendChild(tag);
      });
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è hidden-–ø–æ–ª—è
      document.getElementById("sectionIds").value = teacherData.sectionIds.join(',');
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏ –º–µ–Ω—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    document.getElementById("teacherId").value = teacherData.id;
    document.getElementById("formTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è";
    document.getElementById("saveButton").textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
    document.getElementById("saveButton").onclick = () => saveTeacher(teacherData.id);
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
    const targetRow = Array.from(document.querySelectorAll("#teachersList tr"))
      .find(row => parseInt(row.cells[0].textContent) === teacherData.id);
      
    if (targetRow) {
      targetRow.classList.add("editing");
      targetRow.scrollIntoView({ behavior: "smooth", block: "center" });
    }
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:", error);
    showToast(error.message, "error");
  }
}
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
 async function saveTeacher(id) {
  try {
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
    const fullName = document.getElementById("fullName").value.trim();
    const phone = document.getElementById("phone").value.replace(/\D/g, '');
    const email = document.getElementById("email").value.trim();
    const sectionIds = document.getElementById("sectionIds").value.split(',').filter(Boolean).map(id => parseInt(id));

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (!fullName) {
      showToast("–í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è", "error");
      return;
    }
    
    if (phone.length !== 11) {
      showToast("–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 11 —Ü–∏—Ñ—Ä", "error");
      return;
    }
    
    if (email && !validateEmail(email)) {
      showToast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email", "error");
      return;
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const teacherData = {
      fullName,
      phone,
      email,
      sectionIds
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const response = await fetch(`/api/teachers/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(teacherData),
      credentials: "include"
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    showToast("–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã", "success");
    clearForm();
    loadTeachers();
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:", error);
    showToast(error.message, "error");
  }
}
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    async function deleteTeacher(id) {
  if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è?")) return;
  
  try {
    const response = await fetch(`/api/teachers/${id}`, {
      method: "DELETE",
      credentials: "include"
    });
    
    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    
    showToast("–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω");
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const tbody = document.getElementById("teachersList");
    if (tbody.children.length === 1 && currentPage > 1) {
      currentPage--;
    }
    
    loadTeachers();
  } catch (error) {
    showToast(error.message, "error");
  }
}
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function clearEditing() {
      document.querySelectorAll(".teachers-table tr.editing").forEach(row => row.classList.remove("editing"));
    }
    
    function clearForm() {
      document.getElementById("fullName").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("email").value = "";
      document.getElementById("sectionInput").value = "";
      document.getElementById("sectionIds").value = "";
      document.getElementById("teacherId").value = "";
      document.getElementById("formTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è";
      document.getElementById("saveButton").textContent = "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è";
      document.getElementById("saveButton").onclick = addTeacher;
      document.getElementById("selectedSections").innerHTML = "";
      selectedSections = [];
      clearEditing();
    }
    
    function formatPhone(phone) {
      return phone?.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/, "+$1 ($2) $3-$4-$5") || "-";
    }
    
    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.getElementById("toastContainer").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
function sortTeachers(field) {
  if (sortField === field) {
    sortDirection = sortDirection === "asc" ? "desc" : "asc";
  } else {
    sortField = field;
    sortDirection = "asc";
  }
  currentPage = 1; // ‚Üê –î–æ–±–∞–≤–ª–µ–Ω–æ
  updateSortIndicators();
  loadTeachers();
}

function filterTeachers() {
  currentPage = 1; // ‚Üê –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –µ—Å—Ç—å
  loadTeachers();
}
    
    function updateSortIndicators() {
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
  document.querySelectorAll(".sort-indicator").forEach(el => {
    el.textContent = "‚Üï";
    el.style.display = "inline";
  });
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  const indicator = document.getElementById(`sort-${sortField}`);
  if (indicator) {
    indicator.textContent = sortDirection === "asc" ? "‚Üë" : "‚Üì";
  }
}

 function filterTeachers() {
  currentPage = 1;
  loadTeachers();
}

  function clearFilters() {
  document.getElementById("filterName").value = "";
  document.getElementById("filterSection").value = "";
  filterSectionId = null;
  currentPage = 1;
  loadTeachers();
}
    
    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
function updatePagination(data) {
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
  if (!data.pagination || data.pagination.totalPages <= 1) {
    return;
  }

  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
  const prevButton = createPaginationButton("‚Üê", currentPage > 1, () => {
    if (currentPage > 1) {
      currentPage--;
      loadTeachers();
    }
  });
  pagination.appendChild(prevButton);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—É—â–µ–π
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(data.pagination.totalPages, currentPage + 2);
  
  for (let page = startPage; page <= endPage; page++) {
    const button = createPaginationButton(
      page, 
      page !== currentPage, 
      () => {
        currentPage = page;
        loadTeachers();
      }
    );
    if (page === currentPage) {
      button.classList.add("active");
    }
    pagination.appendChild(button);
  }
  
  // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
  const nextButton = createPaginationButton("‚Üí", currentPage < data.pagination.totalPages, () => {
    if (currentPage < data.pagination.totalPages) {
      currentPage++;
      loadTeachers();
    }
  });
  pagination.appendChild(nextButton);
}
    
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
   async function initAutocomplete() {
  const input = document.getElementById("sectionInput");
  const suggestions = document.getElementById("sectionSuggestions");
  let allSections = [];
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
  async function loadAllSections() {
    const res = await fetch("/api/sections?limit=1000", { credentials: "include" }); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç
    const data = await res.json();
    if (res.ok) allSections = data.data || [];
  }
      
      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
      function showSuggestions(filteredSections) {
        suggestions.innerHTML = "";
        if (filteredSections.length === 0) {
          suggestions.innerHTML = `<li style="color:#999; text-align:center">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</li>`;
        } else {
          filteredSections.forEach(section => {
            const li = document.createElement("li");
            li.textContent = section.name;
            li.onclick = () => {
              if (!selectedSections.some(s => s.id === section.id)) {
                selectedSections.push(section);
                document.getElementById("selectedSections").innerHTML += 
                  `<span class="tag">${section.name} <button onclick="removeSection(${section.id})">√ó</button></span>`;
                document.getElementById("sectionIds").value = selectedSections.map(s => s.id).join(',');
              }
              input.value = "";
              suggestions.classList.remove("show");
            };
            suggestions.appendChild(li);
          });
        }
        suggestions.classList.add("show");
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
      input.addEventListener("input", async (e) => {
        if (allSections.length === 0) await loadAllSections();
        const value = e.target.value.trim().toLowerCase();
        const filtered = allSections.filter(s => s.name.toLowerCase().includes(value));
        showSuggestions(filtered);
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞
      input.addEventListener("focus", async () => {
        if (allSections.length === 0) await loadAllSections();
        showSuggestions(allSections);
      });
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
      document.addEventListener("click", (e) => {
        if (!document.querySelector(".autocomplete-wrapper").contains(e.target)) {
          suggestions.classList.remove("show");
        }
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      await loadAllSections();
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏
    window.removeSection = function(id) {
      selectedSections = selectedSections.filter(s => s.id !== id);
      document.getElementById("selectedSections").innerHTML = "";
      
      selectedSections.forEach(section => {
        document.getElementById("selectedSections").innerHTML += 
          `<span class="tag">${section.name} <button onclick="removeSection(${section.id})">√ó</button></span>`;
      });
      
      document.getElementById("sectionIds").value = selectedSections.map(s => s.id).join(',');
    }
    function createPaginationButton(text, enabled, onClick) {
  const button = document.createElement("button");
  button.textContent = text;
  button.className = "pagination-button";

  if (!enabled) {
    button.disabled = true;
    button.classList.add("disabled");
  } else {
    button.onclick = onClick;
  }

  return button;
}
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
  </script>
</body>
</html>