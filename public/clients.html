<!-- public/clients.html -->
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏ - –ö–ª–∏–µ–Ω—Ç—ã</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>

<!-- –®–∞–ø–∫–∞ -->
<div class="header">
  <img src="/pictures/logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height: 40px; margin-right: 15px;" />
  <h1>–°–≤–æ–∏–º–∏ –†—É–∫–∞–º–∏</h1>
  <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–∞–≤–∞ -->
  <div class="user-greeting" id="userGreeting">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- –ú–µ–Ω—é -->
<nav class="menu">
  <a href="/schedule.html">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
  <a href="/clients.html" class="active">–ö–ª–∏–µ–Ω—Ç—ã</a>
  <!-- –≠—Ç–∏ —Å—Å—ã–ª–∫–∏ –±—É–¥—É—Ç —Å–∫—Ä—ã—Ç—ã –¥–ª—è –º–ª–∞–¥—à–µ–≥–æ –∞–¥–º–∏–Ω–∞ -->
  <a href="/teachers.html" id="teachersLink">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</a>
  <a href="/sections.html" id="sectionsLink">–°–µ–∫—Ü–∏–∏</a>
  <a href="/abonim.html">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</a>
  <a href="/records.html">–ó–∞–ø–∏—Å–∏</a>
  <a href="/login.html" class="logout-button">–í—ã–π—Ç–∏</a>
</nav>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
<div class="container">
  <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
  <div id="toastContainer"></div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ -->
  <div class="client-form">
    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <div class="form-grid">
      <div class="input-group">
        <label for="clientId">ID</label>
        <input type="text" id="clientId" disabled placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" />
      </div>
      <div class="input-group">
        <label for="fullName">–§–ò–û</label>
        <input type="text" id="fullName" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û" required />
      </div>
      <div class="input-group">
        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="phone" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" required />
      </div>
      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="–í–≤–µ–¥–∏—Ç–µ email" required />
      </div>
    </div>
    <button id="saveButton" onclick="addClient()">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="filter-section">
    <h3>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
    <div class="filter-row">
      <div class="input-group">
        <input type="text" id="filterName" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û" oninput="filterClients()" />
      </div>
      <button onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
  <table class="clients-table">
    <thead>
      <tr>
        <th onclick="sortClients('id')">ID <span class="sort-indicator" id="sort-id">‚Üï</span></th>
        <th onclick="sortClients('fullName')">–§–ò–û <span class="sort-indicator" id="sort-fullName">‚Üï</span></th>
        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th>Email</th>
        <th onclick="sortClients('registrationDate')">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ <span class="sort-indicator" id="sort-registrationDate">‚Üï</span></th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="clientsList"></tbody>
  </table>

  <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  <div class="pagination" id="pagination"></div>
</div>

  <script>
    function checkAuth() {
      if (!sessionStorage.getItem("isAuthenticated")) {
        window.location.href = "/login.html";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      checkAuth();
      updateSortIndicators();
      loadClients();
      initFormValidation();
    });

    // ================== –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==================
    let currentPage = 1;
    const itemsPerPage = 10;
    let sortField = "id";
    let sortDirection = "asc";
    let searchQuery = "";

    // ================== –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ==================
    async function loadClients() {
      try {
        const url = new URL("/api/clients", window.location.origin);
        url.searchParams.append("page", currentPage);
        url.searchParams.append("limit", itemsPerPage);
        url.searchParams.append("sort", sortField);
        url.searchParams.append("order", sortDirection);
        url.searchParams.append("search", searchQuery);

        const response = await fetch(url, { credentials: "include" });

        if (response.status === 401) {
          sessionStorage.removeItem("isAuthenticated");
          window.location.href = "/login.html";
          return;
        }

        const data = await response.json();

        if (!response.ok) throw new Error(data.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");

        renderClients(data);
      } catch (error) {
        showToast(error.message, "error");
        console.error("–û—à–∏–±–∫–∞:", error);
      }
    }

    function renderClients(data) {
      const tbody = document.getElementById("clientsList");
      tbody.innerHTML = "";
      if (data.data.length === 0) {
        const row = `<tr><td colspan="6" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
        return;
      }

      data.data.forEach((client) => {
        const row = `
          <tr>
            <td>${client.id}</td>
        <td>${client.fullName || client.full_name || client.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
            <td>${formatPhone(client.phone)}</td>
            <td>${client.email || "-"}</td>
            <td>${formatDate(client.registrationDate)}</td>
            <td class="actions">
              <button onclick="editClient(${client.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
              <button onclick="deleteClient(${client.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      updatePagination(data);
    }

    // ================== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–º ==================
    async function addClient() {
      const fullName = document.getElementById("fullName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!fullName) {
        showToast("–í–≤–µ–¥–∏—Ç–µ –§–ò–û", "error");
        return;
      }

      if (!phone || !/^7\d{10}$/.test(phone)) {
        showToast("–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 7 –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 11 —Ü–∏—Ñ—Ä", "error");
        return;
      }

      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email", "error");
        return;
      }

      try {
        const response = await fetch("/api/clients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fullName, phone, email }),
          credentials: "include",
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.message || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");

        showToast(`–ö–ª–∏–µ–Ω—Ç "${fullName}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω`);

        clearForm();
        loadClients();
      } catch (error) {
        showToast(error.message, "error");
      }
    }

    async function deleteClient(id) {
      if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?")) return;

      try {
        const response = await fetch(`/api/clients/${id}`, {
          method: "DELETE",
          credentials: "include",
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");

        showToast("–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω");
        loadClients();
      } catch (error) {
        showToast(error.message, "error");
      }
    }

    async function saveClient(id) {
      const fullName = document.getElementById("fullName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!fullName) {
        showToast("–í–≤–µ–¥–∏—Ç–µ –§–ò–û", "error");
        return;
      }

      if (!phone || !/^7\d{10}$/.test(phone)) {
        showToast("–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 7 –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 11 —Ü–∏—Ñ—Ä", "error");
        return;
      }

      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email", "error");
        return;
      }

      try {
        const response = await fetch(`/api/clients/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fullName, phone, email }),
          credentials: "include",
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");

        showToast(`–ö–ª–∏–µ–Ω—Ç "${fullName}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω`);
        clearForm();
        loadClients();
      } catch (error) {
        showToast(error.message, "error");
      }
    }

    // ================== –§–∏–ª—å—Ç—Ä –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ==================
    function filterClients() {
      currentPage = 1;
      searchQuery = document.getElementById("filterName").value;
      loadClients();
    }

    function clearFilters() {
      document.getElementById("filterName").value = "";
      searchQuery = "";
      currentPage = 1;
      loadClients();
    }

    function sortClients(field) {
      if (sortField === field) {
        sortDirection = sortDirection === "asc" ? "desc" : "asc";
      } else {
        sortField = field;
        sortDirection = "asc";
      }
      updateSortIndicators();
      loadClients();
    }

    function updateSortIndicators() {
      document.querySelectorAll(".sort-indicator").forEach((el) => {
        el.textContent = "‚Üï";
      });
      const indicator = document.querySelector(`#sort-${sortField}`);
      if (indicator) {
        indicator.textContent = sortDirection === "asc" ? "‚Üë" : "‚Üì";
      }
    }

    // ================== –ü–∞–≥–∏–Ω–∞—Ü–∏—è ==================
    function updatePagination(data) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      const totalPages = data.totalPages || 1;
      const prevButton = document.createElement("button");
      prevButton.textContent = "‚Üê";
      prevButton.disabled = currentPage === 1;
      prevButton.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          loadClients();
        }
      };
      pagination.appendChild(prevButton);

      const pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      pages.forEach((page) => {
        const button = document.createElement("button");
        button.textContent = page;
        button.disabled = page === currentPage;
        button.onclick = () => {
          currentPage = page;
          loadClients();
        };
        pagination.appendChild(button);
      });

      const nextButton = document.createElement("button");
      nextButton.textContent = "‚Üí";
      nextButton.disabled = currentPage === totalPages;
      nextButton.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadClients();
        }
      };
      pagination.appendChild(nextButton);
    }

    // ================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ==================
    function initFormValidation() {
      document.getElementById("phone").addEventListener("input", function (e) {
        let value = this.value.replace(/\D/g, "");
        if (value.length > 0 && value[0] !== "7") {
          value = "7" + value;
        }
        value = value.substring(0, 11);
        this.value = value;
      });
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      toast.style.backgroundColor = type === "error" ? "#f44336" : "#4caf50";
      document.getElementById("toastContainer").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function clearForm() {
      document.getElementById("fullName").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("email").value = "";
      document.getElementById("clientId").value = "";
      document.getElementById("formTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞";
      document.getElementById("saveButton").textContent = "–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞";
      document.getElementById("saveButton").onclick = addClient;

      document.querySelectorAll(".clients-table tr.editing").forEach((row) => {
        row.classList.remove("editing");
      });
    }

    async function editClient(id) {
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
  document.querySelectorAll(".clients-table tr.editing").forEach(row => {
    row.classList.remove("editing");
  });

  try {
    const response = await fetch(`/api/clients/${id}`, {
      credentials: "include",
      headers: {
        'Accept': 'application/json'
      }
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞");
    }

    const client = await response.json();

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    document.getElementById("fullName").value = client.fullName?.trim() || '';
    document.getElementById("phone").value = client.phone?.trim() || '';
    document.getElementById("email").value = client.email?.trim() || '';
    document.getElementById("clientId").value = client.id || '';

    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫—É
    document.getElementById("formTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞";
    document.getElementById("saveButton").textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
    document.getElementById("saveButton").onclick = () => saveClient(id);

    // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –µ—ë
    const targetRow = Array.from(document.querySelectorAll("#clientsList tr")).find(
      row => parseInt(row.cells[0].textContent) === id
    );

    if (targetRow) {
      targetRow.classList.add("editing"); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
      targetRow.scrollIntoView({ behavior: "smooth", block: "center" }); // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å—Ç—Ä–æ–∫–µ
    }

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
    showToast(`–û—à–∏–±–∫–∞: ${error.message}`, "error");
  }
}

    function formatDate(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      return date.toLocaleDateString("ru-RU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });
    }

    function formatPhone(phone) {
      return phone?.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/, "+$1 ($2) $3-$4-$5");
    }
    function clearEditing() {
  document.querySelectorAll(".clients-table tr.editing").forEach(row => row.classList.remove("editing"));
}
async function getUserInfo() {
    try {
      const response = await fetch('/api/auth/check', {
        method: 'GET',
        credentials: 'include'
      });

      if (!response.ok) {
        sessionStorage.removeItem("isAuthenticated");
        window.location.href = "/login.html";
        return null;
      }

      const data = await response.json();
      return data.user || null;

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      sessionStorage.removeItem("isAuthenticated");
      window.location.href = "/login.html";
      return null;
    }
  }

  // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
  function displayUserInfo(user) {
    const greetingElement = document.getElementById('userGreeting');
    if (!greetingElement) return;

    let roleText = '';

    if (user.role === 'admin') {
      roleText = user.type === 'subadmin' ? '–º–ª–∞–¥—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '—Å—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
    } else {
      roleText = user.role;
    }

    greetingElement.innerHTML = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${roleText}`;
  }

  // –°–∫—Ä—ã–≤–∞–µ—Ç –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é –¥–ª—è –º–ª–∞–¥—à–µ–≥–æ –∞–¥–º–∏–Ω–∞
function toggleMenuVisibility(user) {
  // –°–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ —Å–µ–∫—Ü–∏–π
  const teachersLink = document.querySelector('nav.menu a[href="/teachers.html"]');
  const sectionsLink = document.querySelector('nav.menu a[href="/sections.html"]');

  if (user && user.role === 'admin' && user.type === 'subadmin') {
    if (teachersLink) teachersLink.style.display = 'none';
    if (sectionsLink) sectionsLink.style.display = 'none';
  }
}

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω–µ –¥–ª—è subadmin
  window.showToast = function(message, type = "success") {
    const toastContainer = document.getElementById("toastContainer");
    if (!toastContainer) return;

    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerText = message;
    toastContainer.appendChild(toast);

    setTimeout(() => {
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }, 100);
  };

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener("DOMContentLoaded", async () => {
    const user = await getUserInfo();
    if (!user) return;

    displayUserInfo(user);
    toggleMenuVisibility(user);
  });
  </script>
</body>
</html>